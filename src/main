#!/bin/sh

# $m533ia assertion:
#
# Use laptop's sound card ALC256 instead of HDMI by default
# Fixes: no sound in some applications/games.
#
# [m533ia]$ aplay -l:
# card 0: Generic [HD-Audio Generic], device 3: HDMI 0 [HDMI 0]
#   Subdevices: 1/1
#   Subdevice #0: subdevice #0
# card 1: Generic_1 [HD-Audio Generic], device 0: ALC256 Analog [ALC256 Analog]
#   Subdevices: 1/1
#   Subdevice #0: subdevice #0
_alsa_conf() {
    OBJ=\
'defaults.pcm.rate_converter "speexrate_medium"
'
    [ ! "$audio_hq_resamp" ] || OBJ=\
'defaults.pcm.rate_converter "speexrate_best"
'

    [ ! "$m533ia" ] || OBJ="$OBJ"\
'defaults.pcm.card 1
defaults.ctl.card 1
'

    OBJ_PATH='/etc/asound.conf'
    __file_write_ow_soft;
}

# "WantedBy", default.target, ensures systemd will try to start the service on
# boot. Since no other services on the system specifies our, moc.service, we
# essentially tell systemd that default.target "wants us" using WantedBy;
# default.target is equal to runlevel 5 in sysvinit if it is an alias for
# graphical.target, otherwise 3-5 if multi-user.target.
# Symlink is created because the service will not be started if there isn't a
# symlink under a directory with name composed of the WantedBy string +
# '.wants' appended.
#
# Without a symbolic link, the service will be ready to start, but
# it will not be started automatically unless manually started or something
# specifies its start.
#
# Sources:
# https://unix.stackexchange.com/a/506374/431300
#
# Hard dependency mark in systemd:
# Requires=<service>
#
# Hard dependency mark + runtime mark in systemd:
# Requires=<service>
# After=<service>
#
# Soft dependency mark in systemd:
# Wants=<service>
#
# Soft dependency mark + runtime mark in systemd:
# Wants=<service>
# After=<service>
#
# In respect to dependencies, `WantedBy=` string will still be respected
# in all cases.
#
# An alternative to systemd shall be considered.
_autostart() {
    ___AT_SPI_DBUS_BUS_SERVICE() {
        [ ! "${1:-$arch_linux}" ] && {
            OBJ_PATH="$home/.config/systemd/user/at-spi-dbus-bus.service"
            __action -del
        } || {
            OBJ='/dev/null'
            OBJ_PATH="$home/.config/systemd/user/at-spi-dbus-bus.service"
            __obj_link_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___BLUETOOTH_SERVICE() {
        [ ! "${1:-$bluetooth}" ] && {
            OBJ_PATH='/etc/systemd/system/bluetooth.service'
            __action -del

            OBJ_PATH='/etc/systemd/system/multi-user.target.wants/bluetooth.service'
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=Bluetooth service
Requires=dbus.service
After=dbus.service

[Service]
Type=dbus
BusName=org.bluez
ExecStart=/usr/lib/bluetooth/bluetoothd
TimeoutStopSec=3

[Install]
WantedBy=multi-user.target
'

            OBJ_PATH='/etc/systemd/system/bluetooth.service'
            __file_write_ow_soft;

            OBJ='/etc/systemd/system/bluetooth.service'
            OBJ_PATH='/etc/systemd/system/multi-user.target.wants/bluetooth.service'
            __obj_link_ow_soft;
        }
    }
    ___DNSMASQ_SERVICE() {
        [ ! "${1:-$dns0}" = dnsmasq ] && {
            OBJ_PATH='/etc/systemd/system/dnsmasq.service'
            __action -del

            OBJ_PATH='/etc/systemd/system/multi-user.target.wants/dnsmasq.service'
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=Caching DNS server
Wants=dbus.service

[Service]
Type=simple
ExecStart=/usr/bin/dnsmasq -k --user=dnsmasq
TimeoutStopSec=3

[Install]
WantedBy=multi-user.target
'

            OBJ_PATH='/etc/systemd/system/dnsmasq.service'
            __file_write_ow_soft;

            OBJ='/etc/systemd/system/dnsmasq.service'
            OBJ_PATH='/etc/systemd/system/multi-user.target.wants/dnsmasq.service'
            __obj_link_ow_soft;
        }
    }
    ___EVTEST_GRAB_SERVICE() {
        [ ! "${1:-$m533ia}" ] && {
            OBJ_PATH='/etc/systemd/system/evtest-grab.service'
            __action -del

            OBJ_PATH='/etc/systemd/system/multi-user.target.wants/evtest-grab.service'
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=Grab m533ia keyboard at startup

[Service]
Type=simple
ExecStart=/bin/bash -c '\''\
device="$(/usr/bin/awk '\''\'\'''\''\
/AT Translated Set 2 keyboard/ { found=1; next } \
found && /Handlers=/ { \
  for (i=1; i<=NF; i++) \
    if ($i ~ /^event[0-9]+$/) { \
      print "/dev/input/" $i; exit \
    } \
}'\''\'\'''\'' /proc/bus/input/devices)"; \
exec /usr/bin/evtest --grab "$device"'\''
User=root
StandardOutput=null

[Install]
WantedBy=multi-user.target
'

            OBJ_PATH='/etc/systemd/system/evtest-grab.service'
            __file_write_ow_soft;

            OBJ='/etc/systemd/system/evtest-grab.service'
            OBJ_PATH='/etc/systemd/system/multi-user.target.wants/evtest-grab.service'
            __obj_link_ow_soft;
        }
    }
    ___IWD_SERVICE() {
        [ ! "${1:-$wland}" = iwd ] && {
            OBJ_PATH='/etc/systemd/system/iwd.service'
            __action -del

            OBJ_PATH='/etc/systemd/system/multi-user.target.wants/iwd.service'
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=Wireless service

[Service]
ExecStart=/usr/lib/iwd/iwd

[Install]
WantedBy=multi-user.target
'

            OBJ_PATH='/etc/systemd/system/iwd.service'
            __file_write_ow_soft;

            OBJ='/etc/systemd/system/iwd.service'
            OBJ_PATH='/etc/systemd/system/multi-user.target.wants/iwd.service'
            __obj_link_ow_soft;
        }
    }
    ___MOC_SERVICE() {
        [ ! "${1:-$audio_playerd}" = moc ] && {
            OBJ_PATH="$home/.config/systemd/user/moc.service"
            __action -del

            OBJ_PATH="$home/.config/systemd/user/default.target.wants/moc.service"
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=MOC server

[Service]
RemainAfterExit=yes
ExecStart=/usr/bin/mocp -S
ExecStop=/usr/bin/mocp -x
TimeoutStopSec=3

[Install]
WantedBy=default.target
'

            OBJ_PATH="$home/.config/systemd/user/moc.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"

            OBJ="$home/.config/systemd/user/moc.service"
            OBJ_PATH="$home/.config/systemd/user/default.target.wants/moc.service"
            __obj_link_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___ORG_FREEDESKTOP_IMPL_PORTAL_DESKTOP_GTK_SERVICE() {
        [ ! "${1:-$arch_linux}" ] && {
            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.impl.portal.desktop.gtk.service"
            __action -del
        } || {
            OBJ=\
'[D-BUS Service]
Name=org.freedesktop.impl.portal.desktop.gtk
Exec=/usr/bin/true
'

            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.impl.portal.desktop.gtk.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___ORG_FREEDESKTOP_IMPL_PORTAL_DESKTOP_WLR_SERVICE() {
        [ ! "${1:-$arch_linux}" ] && {
            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.impl.portal.desktop.wlr.service"
            __action -del
        } || {
            OBJ=\
'[D-BUS Service]
Name=org.freedesktop.impl.portal.desktop.wlr
Exec=/usr/bin/true
'

            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.impl.portal.desktop.wlr.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___ORG_FREEDESKTOP_IMPL_PORTAL_PERMISSIONSTORE_SERVICE() {
        [ ! "${1:-$arch_linux}" ] && {
            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.impl.portal.PermissionStore.service"
            __action -del
        } || {
            OBJ=\
'[D-BUS Service]
Name=org.freedesktop.impl.portal.PermissionStore
Exec=/usr/bin/true
'

            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.impl.portal.PermissionStore.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___ORG_FREEDESKTOP_PORTAL_DESKTOP_SERVICE() {
        [ ! "${1:-$arch_linux}" ] && {
            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.portal.Desktop.service"
            __action -del
        } || {
            OBJ=\
'[D-BUS Service]
Name=org.freedesktop.portal.Desktop
Exec=/usr/bin/true
'

            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.portal.Desktop.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___ORG_FREEDESKTOP_PORTAL_DOCUMENTS_SERVICE() {
        [ ! "${1:-$arch_linux}" ] && {
            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.portal.Documents.service"
            __action -del
        } || {
            OBJ=\
'[D-BUS Service]
Name=org.freedesktop.portal.Documents
Exec=/usr/bin/true
'

            OBJ_PATH="$home/.local/share/dbus-1/services/org.freedesktop.portal.Documents.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___PIPEWIRE_SERVICE() {
        [ ! "${1:-$audio_server}" = pipewire ] && {
            OBJ_PATH="$home/.config/systemd/user/pipewire.service"
            __action -del

            OBJ_PATH="$home/.config/systemd/user/default.target.wants/pipewire.service"
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=PipeWire Multimedia Service

[Service]
ExecStart=/usr/bin/pipewire

[Install]
WantedBy=default.target
'

            OBJ_PATH="$home/.config/systemd/user/pipewire.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"

            OBJ="$home/.config/systemd/user/pipewire.service"
            OBJ_PATH="$home/.config/systemd/user/default.target.wants/pipewire.service"
            __obj_link_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___PIPEWIRE_MEDIA_SESSION_SERVICE() {
        [ ! "${1:-$pipewire_manager}" = pipewire ] && {
            OBJ_PATH="$home/.config/systemd/user/pipewire-media-session.service"
            __action -del

            OBJ_PATH="$home/.config/systemd/user/default.target.wants/pipewire-media-session.service"
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=PipeWire Media Session Manager
After=pipewire.service
BindsTo=pipewire.service

[Service]
ExecStartPre=/usr/bin/sleep 2
ExecStart=/usr/bin/pipewire-media-session

[Install]
WantedBy=pipewire.service
'

            OBJ_PATH="$home/.config/systemd/user/pipewire-media-session.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"

            OBJ="$home/.config/systemd/user/pipewire-media-session.service"
            OBJ_PATH="$home/.config/systemd/user/default.target.wants/pipewire-media-session.service"
            __obj_link_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___PIPEWIRE_PULSE_SERVICE() {
        [ ! "${1:-$audio_server}" = pipewire ] && {
            OBJ_PATH="$home/.config/systemd/user/pipewire-pulse.service"
            __action -del

            OBJ_PATH="$home/.config/systemd/user/default.target.wants/pipewire-pulse.service"
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=PipeWire PulseAudio
After=pipewire.service
BindsTo=pipewire.service

[Service]
ExecStart=/usr/bin/pipewire-pulse

[Install]
WantedBy=pipewire.service
'

            OBJ_PATH="$home/.config/systemd/user/pipewire-pulse.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"

            OBJ="$home/.config/systemd/user/pipewire-pulse.service"
            OBJ_PATH="$home/.config/systemd/user/default.target.wants/pipewire-pulse.service"
            __obj_link_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___PIPEWIRE_SOCKET() {
        [ ! "${1:-$audio_server}" = pipewire ] && {
            OBJ_PATH="$home/.config/systemd/user/pipewire.socket"
            __action -del
        } || {
            OBJ='/dev/null'
            OBJ_PATH="$home/.config/systemd/user/pipewire.socket"
            __obj_link_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___PIPEWIRE_PULSE_SOCKET() {
        [ ! "${1:-$audio_server}" = pipewire ] && {
            OBJ_PATH="$home/.config/systemd/user/pipewire-pulse.socket"
            __action -del
        } || {
            OBJ='/dev/null'
            OBJ_PATH="$home/.config/systemd/user/pipewire-pulse.socket"
            __obj_link_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___RTKIT_DAEMON_SERVICE() {
        [ ! "${1:-$arch_linux}" ] && {
            OBJ_PATH='/etc/systemd/system/rtkit-daemon.service'
            __action -del
        } || {
            OBJ='/dev/null'
            OBJ_PATH='/etc/systemd/system/rtkit-daemon.service'
            __obj_link_ow_soft;
        }
    }
    ___XDG_DESKTOP_PORTAL_SERVICE() {
        [ ! "${1:-$portal}" ] && {
            OBJ_PATH="$home/.config/systemd/user/xdg-desktop-portal.service"
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=Portal service
PartOf=graphical-session.target

[Service]
Type=dbus
BusName=org.freedesktop.portal.Desktop
ExecStart=/usr/lib/xdg-desktop-portal
Slice=session.slice
'

            OBJ_PATH="$home/.config/systemd/user/xdg-desktop-portal.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___XDG_DESKTOP_PORTAL_GTK_SERVICE() {
        [ ! "${1:-$portal}" ] && {
            OBJ_PATH="$home/.config/systemd/user/xdg-desktop-portal-gtk.service"
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=Portal service (GTK/GNOME implementation)
PartOf=graphical-session.target

[Service]
Type=dbus
BusName=org.freedesktop.impl.portal.desktop.gtk
ExecStart=/usr/lib/xdg-desktop-portal-gtk
Slice=session.slice
'

            OBJ_PATH="$home/.config/systemd/user/xdg-desktop-portal-gtk.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___XDG_DESKTOP_PORTAL_WLR_SERVICE() {
        [ ! "${1:-$portal}" ] && {
            OBJ_PATH="$home/.config/systemd/user/xdg-desktop-portal-wlr.service"
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=Portal service (wlroots implementation)
PartOf=graphical-session.target

[Service]
Type=dbus
BusName=org.freedesktop.impl.portal.desktop.wlr
ExecStart=/usr/lib/xdg-desktop-portal-wlr
Slice=session.slice
'

            OBJ_PATH="$home/.config/systemd/user/xdg-desktop-portal-wlr.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___XDG_DOCUMENT_PORTAL_SERVICE() {
        [ ! "${1:-$portal}" ] && {
            OBJ_PATH="$home/.config/systemd/user/xdg-document-portal.service"
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=flatpak document portal service
PartOf=graphical-session.target

[Service]
Type=dbus
BusName=org.freedesktop.portal.Documents
ExecStart=/usr/lib/xdg-document-portal
Slice=session.slice
'

            OBJ_PATH="$home/.config/systemd/user/xdg-document-portal.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___XDG_PERMISSION_STORE_SERVICE() {
        [ ! "${1:-$portal}" ] && {
            OBJ_PATH="$home/.config/systemd/user/xdg-permission-store.service"
            __action -del
        } || {
            OBJ=\
'[Unit]
Description=sandboxed app permission store
PartOf=graphical-session.target

[Service]
Type=dbus
BusName=org.freedesktop.impl.portal.PermissionStore
ExecStart=/usr/lib/xdg-permission-store
Slice=session.slice
'

            OBJ_PATH="$home/.config/systemd/user/xdg-permission-store.service"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }

    [ "$init" = systemd ] && {
        ___AT_SPI_DBUS_BUS_SERVICE;
        ___BLUETOOTH_SERVICE;

        [ "$dns" ] && {
            ___DNSMASQ_SERVICE;
        } || {
            ___DNSMASQ_SERVICE ''
        }

        ___EVTEST_GRAB_SERVICE;
        ___IWD_SERVICE;
        ___MOC_SERVICE;
        ___ORG_FREEDESKTOP_IMPL_PORTAL_DESKTOP_GTK_SERVICE;
        ___ORG_FREEDESKTOP_IMPL_PORTAL_DESKTOP_WLR_SERVICE;
        ___ORG_FREEDESKTOP_IMPL_PORTAL_PERMISSIONSTORE_SERVICE;
        ___ORG_FREEDESKTOP_PORTAL_DESKTOP_SERVICE;
        ___ORG_FREEDESKTOP_PORTAL_DOCUMENTS_SERVICE;

        ___PIPEWIRE_SERVICE;
        ___PIPEWIRE_PULSE_SERVICE;
        [ "$audio_server" = pipewire ] && {
            ___PIPEWIRE_MEDIA_SESSION_SERVICE;
        } || {
            ___PIPEWIRE_MEDIA_SESSION_SERVICE ''
        }

        [ "$arch_linux" ] && {
            ___PIPEWIRE_SOCKET;
            ___PIPEWIRE_PULSE_SOCKET;
        } || {
            ___PIPEWIRE_SOCKET ''
            ___PIPEWIRE_PULSE_SOCKET ''
        }

        ___RTKIT_DAEMON_SERVICE;
        ___XDG_DESKTOP_PORTAL_SERVICE;
        ___XDG_DESKTOP_PORTAL_GTK_SERVICE;
        ___XDG_DESKTOP_PORTAL_WLR_SERVICE;
        ___XDG_DOCUMENT_PORTAL_SERVICE;
        ___XDG_PERMISSION_STORE_SERVICE;
    } || {
        ___AT_SPI_DBUS_BUS_SERVICE ''
        ___BLUETOOTH_SERVICE ''
        ___DNSMASQ_SERVICE ''
        ___EVTEST_GRAB_SERVICE ''
        ___IWD_SERVICE ''
        ___MOC_SERVICE ''
        ___ORG_FREEDESKTOP_IMPL_PORTAL_DESKTOP_GTK_SERVICE ''
        ___ORG_FREEDESKTOP_IMPL_PORTAL_DESKTOP_WLR_SERVICE ''
        ___ORG_FREEDESKTOP_IMPL_PORTAL_PERMISSIONSTORE_SERVICE ''
        ___ORG_FREEDESKTOP_PORTAL_DESKTOP_SERVICE ''
        ___ORG_FREEDESKTOP_PORTAL_DOCUMENTS_SERVICE ''
        ___PIPEWIRE_SERVICE ''
        ___PIPEWIRE_PULSE_SERVICE ''
        ___PIPEWIRE_MEDIA_SESSION_SERVICE ''
        ___PIPEWIRE_SOCKET ''
        ___PIPEWIRE_PULSE_SOCKET ''
        ___RTKIT_DAEMON_SERVICE ''
        ___XDG_DESKTOP_PORTAL_SERVICE ''
        ___XDG_DESKTOP_PORTAL_GTK_SERVICE ''
        ___XDG_DESKTOP_PORTAL_WLR_SERVICE ''
        ___XDG_DOCUMENT_PORTAL_SERVICE ''
        ___XDG_PERMISSION_STORE_SERVICE ''
    }
}

_bash_conf() {
    OBJ=\
'# System management
sys_pwr_fw() { pwr_fw; }
sys_pwr_off() { pwr_off "$@"; }
sys_pwr_reset() { pwr_reset "$@"; }
sys_pkg_get() { pkg_get "$@"; }
sys_pkg_rm() { pkg_rm "$@"; }
sys_pkg_rmF() { pkg_rmF "$@"; }
sys_up() { up; }
sys_upF() { upF; }

# Package management
pkg_get() (
    case ":$1" in
        :)
            printf "%bERROR:%b No package(s) specified.\n" \
                   "\033[1;31m" "\033[0m"
            exit 2
        ;;
    esac

    ARGS='\''--sync'\''

    while [ "$1" ]; do
        ARGS="$ARGS"" \"$1\""
        shift
    done

    eval "su -c '\''pacman ${ARGS}'\''"
)
pkg_rm() (
    case ":$1" in
        :)
            printf "%bERROR:%b No package(s) specified.\n" \
                   "\033[1;31m" "\033[0m"
            exit 2
        ;;
    esac

    ARGS='\''--remove'\''
    ARGS="$ARGS"'\'' --nosave'\''
    ARGS="$ARGS"'\'' --recursive'\''

    while [ "$1" ]; do
        ARGS="$ARGS"" \"$1\""
        shift
    done

    eval "su -c '\''pacman ${ARGS}'\''"
)
pkg_rmF() (
    case ":$1" in
        :)
            printf "%bERROR:%b No package(s) specified.\n" \
                   "\033[1;31m" "\033[0m"
            exit 2
        ;;
    esac

    ARGS='\''--remove'\''
    ARGS="$ARGS"'\'' --nosave'\''
    ARGS="$ARGS"'\'' --recursive'\''
    ARGS="$ARGS"'\'' -dd'\''

    while [ "$1" ]; do
        ARGS="$ARGS"" \"$1\""
        shift
    done

    eval "su -c '\''pacman ${ARGS}'\''"
)

# Power management
pwr_fw() (
    su -c '\''systemctl reboot --firmware-setup'\''
)
pwr_off() (
    case ":$1" in
        :) su -c '\''shutdown -P now'\'' ;;
        *) su -c "shutdown -P $1" ;;
    esac
)
pwr_reset() (
    case ":$1" in
        :) su -c '\''shutdown -r now'\'' ;;
        *) su -c "shutdown -r $1" ;;
    esac
)

# Update management
up() (
    ARGS='\''--sync'\''
    ARGS="$ARGS"'\'' --refresh'\''
    ARGS="$ARGS"'\'' --sysupgrade'\''

    eval "su -c '\''pacman ${ARGS}'\''"
)
upF() (
    ARGS='\''--sync'\''
    ARGS="$ARGS"'\'' -yyuu'\''

    eval "su -c '\''pacman ${ARGS}'\''"
)

# gpg
gpg_d() {
    gpg -o "${1%.gpg}" -d "$1"
}
gpg_e() {
    gpg -r 7D1F56FAD6FB86652A60BEE65BC3343816EAB179 --compress-algo none -e "$1"
}

# steam
:

# tar
tar_c() {
    [ -e "$1" ] || { echo ENOENT; return 1; }
    [ ! -e "$1".tar ] || { echo EEXIST; return 1; }

    tar --numeric-owner -cvpf "$1".tar "$1"
}
tar_e() {
    if [ ! -e "$1" ] && [ -e "$1".tar ]; then
        set -- "$1".tar
    fi

    tar --numeric-owner -xvpf "$1"
}

# unfinished
steamwinerun() ( WINEPREFIX="$HOME"/.steam/root/steamapps/compatdata/$1/pfx wine "$2"; )
dgrd() (
    if [ ! "$1" ] || [ ! "$2" ]; then
        printf "%s\n" '\''STEP (1-X) = $1'\''
        printf "%s\n" '\''NAME = $2+'\''
        exit 2
    fi

    STEP="$1"; shift
    DIR=/var/cache/pacman/pkg
    OUT_FLAG=0

    while [ "$#" -ge 1 ]; do
        NAME="$1"
        FILES=$(
            find "$DIR" -name "$NAME"-[0123456789]*.zst -printf "%T+ %p\n" | \
            sort -r
        )

        if [ ! "$FILES" ]; then
            printf "%s\n" '\''ERR NO FILES. NAME=%s'\'' "$NAME"
            exit 1
        fi

        x=0; while IFS= read -r LINE; do
            [ "$x" = "$STEP" ] || { x=$((x + 1)); continue; }

            LINE="${LINE#* }"
            if [ "$OUT_FLAG" = 0 ]; then
                printf "%s\n" '\''pacman -U \'\''
                OUT_FLAG=1
            fi
            if [ "$2" ]; then
                printf "%s %s\n" "$LINE" '\''\'\''
            else
                printf "%s\n" "$LINE"
            fi
            shift; continue 2
        done <<EOF
$FILES
EOF

        printf "ERR PKG DGRD STEP NO EXIST. x=%s\n" "$x"
        exit 1
    done
)
ipv6disable() { su -c '\''sysctl -w net.ipv6.conf.all.disable_ipv6=1; sysctl -w net.ipv6.conf.default.disable_ipv6=1'\''; }
ipv6enable() { su -c '\''sysctl -w net.ipv6.conf.all.disable_ipv6=0; sysctl -w net.ipv6.conf.default.disable_ipv6=0'\''; }
'

    OBJ_PATH="$home/.bash_functions"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ=\
'# Don'\''t parse .bashrc if not running interactively
[[ $- != *i* ]] && return

PS1=\
'\''\[\033[1;32m\]['\''\
"\$(\
RC=\$?; \
[ "\$RC" -eq 0 ] \
    && printf "%s%d" '\''\[\033[1;32m\]'\'' "\$RC" \
    || printf "%s%d" '\''\[\033[1;33m\]'\'' "\$RC" \
)"'\'' '\''\
'\''\[\033[1;36m\]\u@\h '\''\
'\''\[\033[1;31m\]\W\[\033[1;32m\]]\$\[\033[0m\] '\''

export HISTCONTROL=ignoreboth:erasedups

alias ls='\''ls --color'\''
alias grep='\''grep --color=always'\''
alias ip='\''ip --color'\''
alias yt-dlp='\''yt-dlp --mtime'\''
alias clr='\''tput reset; stty -ixon susp undef'\''
alias gfix='\''git add .; git commit --amend --date="now" -s'\''
alias gfixf='\''git add .; git commit --amend --date="now" --no-edit -s'\''
alias gchk='\''git diff --check HEAD~10'\''

# Source useful custom functions
[ -f "$HOME"/.bash_functions ] && . "$HOME"/.bash_functions

# '\''-ixon'\'': Disable "Ctrl + S"; WHY IS THIS STILL DEFAULT?
# '\''susp undef'\'': Disable "Ctrl + Z"
stty -ixon susp undef
'

    OBJ_PATH="$home/.bashrc"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_bluez_conf() {
    OBJ=\
'[General]
Name = gUcciestBlueZ420
DiscoverableTimeout = 0
FastConnectable = true

[Policy]
AutoEnable=false
ReconnectAttempts=3
ReconnectIntervals=2,8,16
'

    OBJ_PATH='/etc/bluetooth/main.conf'
    __file_write_ow_soft;
}

# RTC clock sync using the closest NTP server (pool.ntp.org)
_clk_sync() {
    __cmd -- ntpd -gGLnq pool.ntp.org
    __cmd -- hwclock -w
}

# Software configuration - stage 1 - initial system configuration
_conf_1() {
    _alsa_conf;
    _bash_conf;
    _doas_conf;
    _face_bin;
    _fontconfig_conf;
    _git_conf;
    _gtk_conf;
    _hostname;
    _iwd_conf;
    _kitty_conf;
    _kvantum_conf;
    _moc_conf;
    _modprobe_conf;
    _mpv_conf;
    _mutt_conf;
    _nano_conf;
    _openal_conf;
    _pipewire_conf;
    _pipewire_media_session_conf;
    _ranger_conf;
    _sudo_conf;
    _sway_conf;
    _swaylock_conf;
    _sysctl_conf;
    _xdg_conf;
}

# Software configuration - stage 2 - desired system configuration
_conf_2() {
    _autostart;
    _env;
    _featherpad_conf;
    _hosts;
    _locale;
    _reflector;
    _resolv_conf;
    _sh;
    _tz;

    { [ -e '/etc/dhcpcd.conf' ]; } && {
        _dhcpcd_conf;
    } || {
        __info -yellow - 'Skipped _dhcpcd_conf()'
    }

    { [ -e '/etc/dnsmasq.conf' ]; } && {
        _dnsmasq_conf;
    } || {
        __info -yellow - 'Skipped _dnsmasq_conf()'
    }

    { [ -e '/etc/gai.conf' ]; } && {
        _gai_conf;
    } || {
        __info -yellow - 'Skipped _gai_conf()'
    }

    { command -v 'grub-install' && command -v 'grub-mkconfig'; } && {
        _grub;

        { [ -e '/etc/default/grub' ]; } && {
            _grub_conf;
        } || {
            __info -yellow - 'Skipped _grub_conf()'
        }
    } || {
        __info -yellow - 'Skipped _grub()'
        __info -yellow - 'Skipped _grub_conf()'
    }

    { [ -e '/etc/mkinitcpio.conf' ]; } && {
        _initramfs_conf;
    } || {
        __info -yellow - 'Skipped _initramfs_conf()'
    }

    { [ -e '/etc/makepkg.conf' ]; } && {
        _makepkg_conf;
    } || {
        __info -yellow - 'Skipped _makepkg_conf()'
    }

    { [ -e '/etc/pacman.conf' ]; } && {
        _pacman_conf;
    } || {
        __info -yellow - 'Skipped _pacman_conf()'
    }

    { [ -e '/etc/security/faillock.conf' ] && [ -e '/etc/login.defs' ] && \
        [ -e '/etc/pam.d/su' ] && [ -e '/etc/pam.d/system-auth' ]; } && {
        _pam_conf;
    } || {
        __info -yellow - 'Skipped _pam_conf()'
    }
}

# Software configuration - stage 3 - desired dependable system configuration
_conf_3() {
    { [ -e '/etc/bluetooth/main.conf' ]; } && {
        _bluez_conf;
    } || {
        __info -yellow - 'Skipped _bluez_conf()'
    }

    { [ -e "$home/.mozilla/firefox/profiles.ini" ]; } && {
        _firefox_conf;
    } || {
        __info -yellow - 'Skipped _firefox_conf()'
    }

    { [ -e '/etc/fuse.conf' ]; } && {
        _fuse_conf;
    } || {
        __info -yellow - 'Skipped _fuse_conf()'
    }
}

# Software configuration - stage 4 - desired system configuration
#
# Run stage 4 at any time of desired system configuration with the intent
# of reproducing the currently declared configuration; configuration is
# affected by our values/switches/variables.
_conf_4() {
    _alsa_conf;
    _autostart;
    _env;
    _hostname;
    _hosts;
    _iwd_conf;
    _pipewire_conf;
    _pipewire_media_session_conf;
    _reflector;
    _resolv_conf;
    _sh;
    _sway_conf;
    _tz;

    { [ ! -e '/etc/dhcpcd.conf' ]; } || {
        _dhcpcd_conf;
    }

    { [ ! -e '/etc/dnsmasq.conf' ]; } || {
        _dnsmasq_conf;
    }

    { [ ! -e '/etc/gai.conf' ]; } || {
        _gai_conf;
    }

    { [ ! -e '/etc/default/grub' ] || ! command -v 'grub-mkconfig'; } || {
        _grub_conf;
    }

    { [ ! -e '/etc/mkinitcpio.conf' ]; } || {
        _initramfs_conf;
    }
}

_dhcpcd_conf() {
    OBJ=\
'static domain_name_servers=127.0.0.1
clientid
noipv6
'
    [ ! "$ipv6" ] || OBJ=\
'static domain_name_servers=::1 127.0.0.1
duid
slaac private
'

    OBJ="$OBJ"\
'option classless_static_routes
option interface_mtu
option host_name
option rapid_commit
require dhcp_server_identifier

noarp
nohook resolv.conf
noipv4ll
'

    OBJ_PATH='/etc/dhcpcd.conf'
    __file_write_ow_soft;
}

# DNS stub resolver configuration
_dnsmasq_conf() {
    OBJ=\
'bind-interfaces
cache-size=2048
domain-needed
bogus-priv
no-resolv
no-poll
no-hosts
no-negcache
dnssec
dnssec-check-unsigned
trust-anchor=.,20326,8,2,E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237C7F8EC8D
trust-anchor=.,38696,8,2,683D2D0ACB8C9B712A1948B27F741219298D0A450D612C483AF444A4C0FB2B16
all-servers
'

    [ "$ipv6" ] && {
        OBJ="$OBJ"\
'listen-address=::1,127.0.0.1
server=2606:4700:4700::1111
server=2606:4700:4700::1001
server=2620:119:35::35
server=2620:119:53::53
server=2001:4860:4860::8888
server=2001:4860:4860::8844
server=2620:fe::fe
server=2620:fe::9
server=1.1.1.1
server=1.0.0.1
server=208.67.222.222
server=208.67.220.220
server=8.8.8.8
server=8.8.4.4
server=9.9.9.9
server=149.112.112.112
'
    } || {
        OBJ="$OBJ"\
'listen-address=127.0.0.1
server=1.1.1.1
server=1.0.0.1
server=208.67.222.222
server=208.67.220.220
server=8.8.8.8
server=8.8.4.4
server=9.9.9.9
server=149.112.112.112
'
    }

    OBJ_PATH='/etc/dnsmasq.conf'
    __file_write_ow_soft;
}

_doas_conf() {
    OBJ=\
'permit persist :wheel as root
'

    OBJ_PATH='/etc/doas.conf'
    __file_write_ow_soft -mode 0400
}

_env() {
    ___BASH_PROFILE() {
        OBJ=\
'set -a; for file in "$HOME"/.syscfg_env/*; do
    . "$file"
done; set +a
'

        [ ! "${1:-$wm}" = sway ] || OBJ="$OBJ"\
'
if [ -z "$DISPLAY" ] && [ "$(tty)" = '\''/dev/tty1'\'' ]; then
    if command -v sway > /dev/null 2>&1; then
        exec sway > /var/log/sway.log 2>&1
    fi
fi
'

        OBJ_PATH="$home/.bash_profile"
        __file_write_ow_soft \
            -uid "$uid" -gid "$gid" \
            -user "$user" -group "$group"
    }
    ___BROWSER() {
        [ ! "${1:-$browser}" = firefox ] && {
            OBJ_PATH="$home/.syscfg_env/browser"
            __action -del
        } || {
            OBJ=\
'MOZ_ENABLE_WAYLAND=1
'

            OBJ_PATH="$home/.syscfg_env/browser"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___DISPLAY_SERVER() {
        [ ! "$display_server" = wayland ] && {
            OBJ_PATH="$home/.syscfg_env/display_server"
            __action -del
        } || {
            OBJ=\
'GTK_A11Y=none
GDK_BACKEND=wayland
QT_QPA_PLATFORM=wayland
QT_WAYLAND_DISABLE_WINDOWDECORATION=1
SDL_VIDEODRIVER=wayland
'

            OBJ_PATH="$home/.syscfg_env/display_server"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___ENV() {
        OBJ=\
'EDITOR=nano
PATH="${PATH}:$HOME/.local/bin:$HOME/scripts"
'

        OBJ_PATH="$home/.syscfg_env/env"
        __file_write_ow_soft \
            -uid "$uid" -gid "$gid" \
            -user "$user" -group "$group"
    }
    ___PORTAL() {
        [ ! "${1:-$portal}" ] && {
            OBJ_PATH="$home/.syscfg_env/portal"
            __action -del
        } || {
            OBJ=\
'GTK_USE_PORTAL=1
'

            OBJ_PATH="$home/.syscfg_env/portal"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___QT_THEME() {
        [ ! "${1:-$qt_theme}" = kvantum ] && {
            OBJ_PATH="$home/.syscfg_env/qt_theme"
            __action -del
        } || {
            OBJ=\
'QT_STYLE_OVERRIDE=kvantum
'

            OBJ_PATH="$home/.syscfg_env/qt_theme"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }
    ___SWAY_LOG() {
        [ ! "${1:-$wm}" = sway ] && {
            OBJ_PATH='/var/log/sway.log'
            __action -del
        } || {
            OBJ_PATH='/var/log/sway.log'
            __action -trunc

            __cmd -- chmod 0644 '/var/log/sway.log'
            __cmd -- chown "$uid":"$gid" '/var/log/sway.log'
        }
    }
    ___WM() {
        [ ! "${1:-$wm}" = sway ] && {
            OBJ_PATH="$home/.syscfg_env/wm"
            __action -del
        } || {
            OBJ=\
'XDG_CURRENT_DESKTOP=sway
XDG_SESSION_DESKTOP=sway
DESKTOP_SESSION=sway
'

            OBJ_PATH="$home/.syscfg_env/wm"
            __file_write_ow_soft \
                -uid "$uid" -gid "$gid" \
                -user "$user" -group "$group"
        }
    }

    ___DISPLAY_SERVER;
    ___ENV;

    [ "$display_server" = wayland ] && {
        ___BASH_PROFILE;
        ___BROWSER;
        ___PORTAL;
        ___QT_THEME;
        ___SWAY_LOG;
        ___WM;
    } || {
        ___BASH_PROFILE ''
        ___BROWSER ''
        ___PORTAL ''
        ___QT_THEME ''
        ___SWAY_LOG ''
        ___WM ''
    }
}

# .face png in $home (user $HOME); some applications use this file.
_face_bin() {
    OBJ=\
'\0211\0120\0116\0107\0015\0012\0032\0012\0000\0000\0000\0015\0111\0110\0104\0122\0000\0000\0000\0144\0000\0000\0000\0144\0010\0002\0000\0000\0000\0377\0200\0002\0003\0000\0000\0000\0003\0163\0102\0111\0124\0010\0010\0010\0333\0341\0117\0340\0000\0000\0010\0010\0111\0104\0101\0124\0170\0234\0355\0235\0117\0150\0023\0117\0024\0307\0137\0252\0325\0370\0277\0326\0077\0304\0077\0075\0010\0125\0243\0124\0232\0050\0005\0251\0010\0332\0136\0104\0004\0053\0036\0104\0301\0322\0256\0005\0017\0005\0351\0101\0017\0036\0212\0207\0212\0050\0071\0064\0170\0116\0215\0030\0355\0105\0321\0252\0330\0253\0101\0244\0212\0042\0046\0324\0103\0113\0212\0177\0132\0264\0242\0025\0135\0250\0156\0252\0326\0375\0035\0346\0327\0141\0234\0375\0237\0314\0314\0116\0045\0237\0123\0166\0166\0063\0373\0366\0333\0231\0267\0157\0346\0315\0244\0001\0135\0327\0241\0204\0073\0312\0374\0066\0140\0066\0121\0022\0313\0003\0045\0261\0074\0120\0022\0313\0003\0045\0261\0074\0060\0013\0304\0112\0247\0323\0175\0175\0175\0176\0133\0001\0060\0053\0304\0112\0245\0122\0207\0016\0035\0272\0172\0365\0252\0337\0206\0000\0350\0162\0323\0335\0335\0215\0115\0115\0046\0223\0376\0032\0043\0173\0313\0032\0031\0031\0301\0237\0133\0133\0133\0375\0155\0137\0054\0305\0312\0144\0062\0055\0055\0055\0147\0317\0236\0145\0130\0047\0205\0317\0172\0261\0155\0250\0065\0065\0065\0000\0120\0133\0133\0313\0252\0302\0366\0366\0166\0243\0315\0167\0356\0334\0141\0125\0277\0047\0030\0167\0303\0301\0301\0301\0171\0363\0346\0145\0263\0331\0160\0070\0314\0266\0146\0222\0267\0157\0337\0362\0253\0334\0006\0366\0076\0353\0324\0251\0123\0000\0060\0074\0074\0314\0111\0057\0105\0121\0072\0072\0072\0170\0324\0354\0010\0173\0261\0142\0261\0130\0165\0165\0065\0160\0323\0153\0303\0206\0015\0314\0353\0164\0111\0121\0142\0145\0062\0031\0323\0160\0061\0227\0313\0141\0275\0366\0356\0335\0133\0314\0055\0244\0242\0050\0261\0042\0221\0110\0062\0231\0104\0375\0216\0042\0227\0313\0125\0124\0124\0000\0100\0072\0235\0276\0161\0343\0106\0061\0167\0261\0047\0036\0217\0007\0002\0001\0176\0365\0223\0024\0333\0015\0357\0336\0275\0333\0327\0327\0267\0151\0323\0046\0143\0304\0360\0365\0353\0327\0271\0163\0347\0002\0000\0127\0027\0063\0070\0070\0310\0257\0162\0012\0006\0076\0153\0164\0164\0364\0335\0273\0167\0027\0057\0136\0154\0153\0153\0243\0116\0041\0231\0046\0046\0046\0166\0355\0332\0125\0374\0215\0214\0234\0077\0177\0376\0312\0225\0053\0074\0152\0066\0207\0131\0014\0122\0126\0006\0146\0021\0026\0352\0214\0000\0160\0374\0370\0361\0002\0252\0065\0306\0131\0135\0135\0135\0350\0124\0127\0127\0027\0363\0247\0260\0207\0331\0333\0160\0172\0172\0072\0020\0010\0144\0263\0331\0225\0053\0127\0222\0345\0270\0063\0246\0122\0051\0206\0316\0053\0036\0217\0167\0166\0166\0262\0252\0315\0045\0054\0103\0207\0077\0177\0376\0000\0300\0227\0057\0137\0202\0301\0040\0131\0216\0175\0126\0001\0043\0041\0112\0172\0104\0042\0221\0270\0166\0355\0132\0101\0066\0026\0005\0343\0070\0113\0327\0165\0000\0230\0232\0232\0042\0365\0212\0305\0142\0353\0326\0255\0003\0200\0261\0261\0061\0257\0221\0304\0304\0304\0204\0261\0060\0223\0311\0274\0174\0371\0262\0070\0113\0013\0201\0175\0120\0212\0365\0132\0270\0160\0041\0056\0074\0172\0364\0050\0372\0120\0174\0044\0061\0060\0060\0060\0060\0060\0120\0114\0015\0205\0303\0311\0027\0242\0312\0053\0052\0052\0160\0011\0152\0134\0000\0260\0177\0377\0176\0367\0365\0234\0076\0175\0332\0307\0247\0240\0340\0170\0033\0024\0053\0256\0130\0261\0002\0035\0222\0217\0175\0375\0372\0165\0367\0365\0140\0225\0377\0145\0261\0364\0031\0275\0252\0253\0253\0321\0141\0141\0215\0313\0164\0226\0306\0027\0261\0370\0316\0224\0176\0370\0360\0001\0000\0106\0106\0106\0220\0137\0157\0152\0152\0102\0345\0375\0375\0375\0356\0075\0227\0351\0013\0321\0027\0370\0212\0025\0012\0205\0132\0133\0133\0001\0040\0235\0116\0267\0265\0265\0055\0130\0260\0000\0237\0352\0355\0355\0165\0131\0211\0351\0013\0221\0244\0256\0256\0256\0140\0013\0275\0041\0240\0365\0342\0111\0225\0023\0047\0116\0220\0016\0310\0245\0347\0262\0357\0206\0212\0242\0360\0266\0037\0043\0042\0141\0361\0372\0365\0353\0245\0113\0227\0002\0100\0117\0117\0317\0326\0255\0133\0161\0271\0313\0306\0225\0315\0146\0155\0316\0212\0234\0336\0022\0224\0335\0121\0125\0025\0015\0036\0037\0075\0172\0204\0013\0135\0172\0256\0071\0163\0346\0330\0234\0135\0274\0170\0161\0361\0346\0271\0144\0256\0260\0073\0115\0117\0117\0227\0225\0225\0115\0115\0115\0221\0205\0157\0336\0274\0161\0374\0242\0225\0317\0332\0261\0143\0307\0341\0303\0207\0205\0116\0061\0013\0353\0360\0272\0131\0204\0351\0030\0103\0220\0111\0126\0222\0140\0060\0070\0076\0076\0056\0306\0154\0214\0350\0214\0364\0242\0105\0213\0250\0307\0266\0167\0363\0212\0242\0230\0212\0325\0331\0331\0051\0314\0146\0214\0150\0261\0352\0353\0353\0251\0307\0306\0363\0123\0106\0056\0135\0272\0144\0252\0324\0366\0355\0333\0105\0332\0214\0021\0235\0276\0067\0212\0145\0105\0076\0237\0267\0352\0203\0113\0226\0054\0141\0147\0221\0007\0104\0213\0025\0213\0305\0052\0053\0053\0335\0134\0171\0341\0302\0205\0217\0037\0077\0232\0236\0232\0077\0177\0076\0123\0243\0334\0342\0303\0302\0020\0074\0135\0143\0317\0373\0367\0357\0255\0116\0215\0216\0216\0262\0063\0307\0003\0376\0257\0242\0061\0215\0071\0343\0361\0270\0115\0046\0142\0150\0150\0150\0150\0150\0210\0247\0121\0346\0370\0057\0326\0203\0007\0017\0214\0205\0337\0276\0175\0263\0377\0326\0275\0173\0367\0370\0230\0143\0207\0377\0142\0151\0232\0266\0173\0367\0156\0257\0337\0372\0371\0363\0047\0017\0143\0354\0361\0137\0054\0000\0170\0374\0370\0061\0065\0356\0031\0033\0033\0363\0313\0030\0033\0244\0020\0013\0376\0036\0124\0333\0073\0054\0304\0357\0337\0277\0071\0133\0144\0202\0017\0142\0151\0232\0146\0054\0044\0007\0325\0246\0316\0073\0032\0215\0222\0207\0317\0237\0077\0347\0141\0233\0003\0202\0203\0140\0253\0070\0023\0146\0306\0211\0232\0246\0205\0102\0041\0343\0131\0343\0014\0237\0247\0211\0174\0046\0210\0233\0165\0100\0220\0013\0152\0051\0120\0343\0032\0036\0036\0066\0215\0105\0311\0304\0032\0042\0227\0313\0061\0066\0316\0011\0321\0142\0331\0323\0333\0333\0153\0332\0254\0140\0046\0035\0111\0202\0126\0005\0210\0104\0012\0261\0312\0313\0313\0177\0375\0372\0005\0000\0375\0375\0375\0246\0027\0050\0212\0162\0346\0314\0231\0055\0133\0266\0210\0265\0213\0106\0264\0203\0067\0365\0356\0015\0015\0015\0366\0337\0332\0274\0171\0163\0070\0034\0246\0026\0135\0212\0177\0041\0012\0025\0313\0064\0046\0120\0024\0005\0255\0251\0264\0042\0030\0014\0066\0067\0067\0003\0000\0025\0273\0212\0357\0206\0102\0305\0062\0365\0356\0216\0031\0207\0366\0366\0166\0344\0310\0326\0256\0135\0113\0226\0377\0343\0055\0313\0264\0017\0002\0000\0231\0117\0064\0262\0176\0375\0172\0364\0101\0125\0125\0262\0034\0255\0160\0022\0212\0260\0040\0305\0052\0302\0102\0063\0245\0126\0013\0032\0310\0264\0340\0370\0370\0070\0231\0351\0011\0207\0303\0302\0214\0107\0210\0153\0131\0126\0021\0026\0312\0145\0341\0314\0076\0005\0331\0111\0103\0241\0320\0221\0043\0107\0360\0241\0370\0211\0032\0101\0142\0045\0022\0011\0323\0105\0125\0216\0333\0045\0250\0264\0340\0306\0215\0033\0311\0103\0301\0023\0065\0202\0304\0262\0132\0253\0207\0033\0216\0351\0024\0240\0243\0224\0077\0176\0374\0140\0142\0236\0113\0104\0210\0145\0325\0254\0200\0150\0070\0224\0363\0106\0124\0125\0125\0121\0045\0124\0302\0125\0260\0217\0027\0041\0326\0223\0047\0117\0114\0233\0225\0143\0303\0061\0106\0122\0324\0362\0243\0313\0227\0057\0347\0363\0371\0342\0055\0164\0011\0307\0315\0231\0211\0104\0142\0337\0276\0175\0015\0015\0015\0126\0223\0123\0216\0021\0226\0061\0222\0242\0032\0240\0252\0252\0075\0075\0075\0205\0332\0353\0031\0226\0101\0160\0044\0022\0171\0361\0342\0305\0253\0127\0257\0122\0251\0124\0115\0115\0315\0247\0117\0237\0154\0326\0024\0107\0243\0321\0110\0044\0142\0137\0041\0336\0160\0200\0071\0170\0360\0140\0074\0036\0047\0113\0076\0177\0376\0134\0260\0301\0236\0141\0036\0214\0240\0325\0105\0216\0120\0211\0350\0155\0333\0266\0121\0027\0230\0246\0235\0065\0115\0243\0026\0331\0237\0073\0167\0216\0371\0043\0130\0301\0336\0147\0251\0252\0352\0250\0027\0325\0254\0022\0211\0204\0261\0201\0054\0137\0276\0334\0370\0305\0140\0060\0270\0163\0347\0116\0262\0104\0344\0010\0221\0213\0203\0167\0324\0253\0271\0271\0371\0300\0201\0003\0350\0163\0046\0223\0271\0165\0353\0226\0125\0362\0331\0010\0025\0152\0211\0034\0041\0362\0372\0263\0250\0252\0272\0152\0325\0052\0352\0115\0037\0215\0106\0053\0053\0053\0033\0033\0033\0311\0227\0140\0044\0022\0131\0263\0146\0215\0373\0232\0251\0165\0070\0102\0243\0007\0256\0235\0274\0251\0251\0251\0256\0256\0256\0161\0206\0373\0367\0357\0133\0135\0151\0164\0366\0215\0215\0215\0246\0127\0122\0043\0304\0075\0173\0366\0160\0063\0237\0106\0226\0137\0014\0061\0256\0262\0265\0022\0113\0327\0365\0143\0307\0216\0341\0313\0202\0301\0240\0246\0151\0142\0214\0224\0045\0157\0150\0144\0365\0352\0325\0126\0247\0110\0267\0225\0317\0347\0237\0076\0175\0052\0304\0042\0151\0222\0254\0106\0310\0165\0315\0024\0224\0053\0174\0366\0354\0031\0177\0163\0000\0344\0021\0313\0323\0066\0212\0362\0362\0162\0362\0160\0162\0162\0222\0265\0071\0346\0310\0042\0226\0161\0111\0262\0115\0114\0160\0362\0344\0111\0362\0120\0330\0010\0121\0026\0261\0214\0330\0104\0233\0124\0246\0107\0330\0010\0121\0026\0261\0274\0356\0146\0242\0062\0075\0142\0106\0210\0262\0210\0365\0375\0373\0167\0117\0327\0123\0356\0137\0314\0240\0107\0026\0261\0360\0076\0152\0214\0375\0070\0246\0243\0243\0243\0245\0245\0005\0037\0212\0131\0333\0046\0213\0130\0140\0310\0131\0070\0066\0226\0144\0062\0211\0365\0272\0171\0363\0046\0047\0253\0110\0044\0022\0253\0200\0115\0230\0130\0057\0061\0231\0036\0211\0304\0242\0334\0226\0313\0351\0004\0254\0227\0210\0114\0217\0230\0121\0225\0113\0226\0055\0133\0206\0015\0363\0264\0217\0272\0273\0273\0373\0341\0303\0207\0334\0354\0372\0037\0271\0304\0242\0266\0215\0211\0137\0333\0147\0217\0104\0335\0020\0014\0357\0104\0067\0273\0021\0105\0042\0227\0130\0360\0367\0146\0225\0333\0267\0157\0373\0150\0211\0011\0176\0067\0155\0023\0012\0330\0164\0056\0006\0351\0132\0026\0374\0335\0270\0344\0352\0211\0176\0377\0265\0314\0301\0211\0173\0117\0357\0104\0336\0110\0052\0226\0116\0154\0020\0226\0247\0047\0312\0330\0015\0021\0223\0223\0223\0150\0304\0343\0376\0267\0105\0170\0043\0257\0130\0000\0020\0213\0305\0300\0343\0017\0327\0360\0305\0357\0246\0355\0000\0032\0312\0124\0125\0125\0371\0155\0210\0256\0313\0354\0263\0060\0110\0257\0372\0372\0172\0277\0015\0231\0015\0142\0351\0063\0172\0025\0366\0343\0235\0014\0231\0035\0142\0351\0063\0172\0371\0373\0146\0224\0142\0357\0216\0033\0222\0311\0144\0155\0155\0255\0233\0237\0264\0343\0107\0100\0057\0375\0143\0065\0327\0110\0035\0072\0310\0106\0111\0054\0017\0224\0304\0362\0100\0111\0054\0017\0224\0304\0362\0100\0111\0054\0017\0374\0007\0045\0367\0037\0310\0075\0064\0164\0315\0000\0000\0000\0000\0111\0105\0116\0104\0256\0102\0140\0202'

    OBJ_PATH="$home/.face"
    __bin_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_featherpad_conf() {
    OBJ=\
'[text]
appendEmptyLine=true
autoBracket=false
autoReplace=false
autoSave=false
autoSaveInterval=1
darkBgColorValue=30
darkColorScheme=true
dateFormat=
dictionaryPath=
executeCommand=
executeScripts=false
font="Source Code Pro,12,-1,5,50,0,0,0,0,0"
inertialScrolling=false
lightBgColorValue=255
lineNumbers=true
maxSHSize=2
noIndent=false
noSyntaxHighlighting=false
noWrap=false
pastePaths=false
recentFiles=
recentFilesNumber=10
recentOpened=false
removeTrailingSpaces=false
saveLastFilesList=false
saveUnmodified=false
scrollJumpWorkaround=false
selectionHighlighting=false
showEndings=false
showWhiteSpace=false
skipNonText=true
spellCheckFromStart=false
textMargin=false
textTabSize=8
thickCursor=false
vLineDistance=80

[window]
closeWithLastTab=false
disableMenubarAccel=false
fullscreen=false
hideSearchbar=false
hideSingleTab=false
max=true
menubarTitle=false
nativeDialog=true
noMenubar=false
noToolbar=true
openInWindows=false
position=none
prefSize=@Size(497 530)
sharedSearchHistory=false
showCursorPos=false
showLangSelector=false
showStatusbar=true
sidePaneMode=false
size=@Size(700 500)
splitterPos=20
startSize=@Size(700 500)
sysIcons=false
tabPosition=0
tabWrapAround=false
'

    OBJ_PATH="$home/.config/featherpad/fp.conf"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_firefox_conf() {
    __cmd -- \
        git clone \
        --depth 1 \
        'https://github.com/mscalindt/firefox-profile' \
        "${TMPDIR:-/tmp}"/firefox-profile

    OBJ="${TMPDIR:-/tmp}/firefox-profile/src/mscalindt"
    OBJ_PATH="$home/.mozilla/firefox/mscalindt"
    __obj_write \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group" \
        -no-avoid

    __cmd -- chown -Rh "$uid":"$gid" -- "$home/.mozilla/firefox/mscalindt"

    OBJ="${TMPDIR:-/tmp}/firefox-profile/src/profiles.ini"
    OBJ_PATH="$home/.mozilla/firefox/profiles.ini"
    __obj_write \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ_PATH="$home/.mozilla/firefox/installs.ini"
    __action -del

    OBJ_PATH="${TMPDIR:-/tmp}"/firefox-profile
    __action -del
}

_fontconfig_conf() {
    OBJ=\
'<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
  <alias>
    <family>serif</family>
    <prefer>
      <family>DejaVu Serif</family>
    </prefer>
  </alias>
  <alias>
    <family>DejaVu Serif</family>
    <default>
      <family>serif</family>
    </default>
  </alias>

  <alias>
    <family>sans-serif</family>
    <prefer>
      <family>Cantarell</family>
    </prefer>
  </alias>
  <alias>
    <family>Cantarell</family>
    <default>
      <family>sans-serif</family>
    </default>
  </alias>

  <alias>
    <family>monospace</family>
    <prefer>
      <family>Cantarell</family>
    </prefer>
  </alias>
  <alias>
    <family>Cantarell</family>
    <default>
      <family>monospace</family>
    </default>
  </alias>
</fontconfig>
'

    OBJ_PATH="$home/.config/fontconfig/conf.d/01-font.conf"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_fuse_conf() {
    OBJ=\
'user_allow_other
'

    OBJ_PATH='/etc/fuse.conf'
    __file_write_ow_soft;
}

_gai_conf() {
    OBJ=\
'precedence ::ffff:0:0/96  100
'

    [ "$ipv6" ] && {
        OBJ_PATH='/etc/gai.conf'
        __action -del
    } || {
        OBJ_PATH='/etc/gai.conf'
        __file_write_ow_soft;
    }
}

_git_conf() {
    OBJ=\
'[core]
	editor = nano
[credential]
	helper = cache --timeout=86400
[http]
	version = HTTP/2
[merge]
	log = 10000
[rerere]
	enabled = true
[sendemail]
        smtpuser = mscalindt@gmail.com
	smtpserver = smtp.gmail.com
	smtpencryption = tls
	smtpserverport = 587
[user]
	email = mscalindt@protonmail.com
	name = Dimitar Yurukov
	signingkey = 7D1F56FAD6FB86652A60BEE65BC3343816EAB179
[commit]
	gpgsign = 1
[color "diff"]
	old = red
	new = yellow
'

    OBJ_PATH="$home/.gitconfig"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_gov_performance() {
    for OBJ_PATH in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
        OBJ=\
'performance
'

        __file_write_ow_soft;
    done
}

_gov_schedutil() {
    for OBJ_PATH in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
        OBJ=\
'schedutil
'

        __file_write_ow_soft;
    done
}

# "Removable" GRUB UEFI installation (NVRAM-less... when no NVRAM entries)
_grub() {
    __cmd -- \
        grub-install \
        --target=x86_64-efi \
        --efi-directory="$efi_mnt" \
        --boot-directory="$efi_mnt"/EFI/BOOT \
        --removable \
        --no-nvram

    __cmd -- grub-mkconfig -o "$efi_mnt"/EFI/BOOT/grub/grub.cfg
}

# To simulate a config file, we drop-in our replacement of /etc/default/grub,
# even though this shall usually only be done in a predefined environment
# (such as ours: 'syscfg grub grub-conf')
#
# As indicated by the above statement, GRUB is old and rather fixed on its
# configuration; that is, it does not provide the same flexibility as, for
# example, the configuration of rEFInd. rEFInd should be considered as a
# replacement.
_grub_conf() {
    OBJ=\
'GRUB_PRELOAD_MODULES="part_gpt"
GRUB_TIMEOUT_STYLE=menu
GRUB_TERMINAL_INPUT=console
GRUB_GFXMODE=auto
GRUB_GFXPAYLOAD_LINUX=keep
GRUB_DISABLE_RECOVERY=true

GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_CMDLINE_LINUX="\
loglevel=3 nowatchdog mitigations=off processor.ignore_ppc=1 \
usbhid.mousepoll=1 tsc=unstable \
'

    [ "$ipv6" ] || OBJ="$OBJ"\
'ipv6.disable=1 \
'

    OBJ="$OBJ"\
'"
'

    [ ! "$arch_linux" ] || OBJ="$OBJ"\
'GRUB_DISTRIBUTOR="Arch"
'

    OBJ_PATH='/etc/default/grub'
    __file_write_ow_soft;

    __cmd -- grub-mkconfig -o "$efi_mnt"/EFI/BOOT/grub/grub.cfg
}

_gtk_conf() {
    OBJ=\
'gtk-cursor-theme-name="Breeze"
gtk-font-name="Cantarell 12"
#gtk-document-font-name="DejaVu Serif 12"
#gtk-monospace-font-name="Cantarell 12"
gtk-cursor-theme-size=0
gtk-application-prefer-dark-theme=true
gtk-enable-primary-paste=false
gtk-toolbar-style=GTK_TOOLBAR_ICONS
gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
gtk-button-images=1
gtk-menu-images=1
gtk-enable-event-sounds=0
gtk-enable-input-feedback-sounds=0
gtk-xft-antialias=1
gtk-xft-hinting=1
gtk-xft-hintstyle=hintfull
gtk-xft-rgba=rgb
'

    OBJ_PATH="$home/.gtkrc-2.0"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ=\
'.titlebar,
window {
	border-radius: 0;
	box-shadow: none;
}

decoration {
	box-shadow: none;
}

decoration:backdrop {
	box-shadow: none;
}
'

    OBJ_PATH="$home/.config/gtk-3.0/gtk.css"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ=\
'[Settings]
gtk-cursor-theme-name="Breeze"
gtk-font-name="Cantarell 12"
#gtk-document-font-name="DejaVu Serif 12"
#gtk-monospace-font-name="Cantarell 12"
gtk-cursor-theme-size=0
gtk-application-prefer-dark-theme=true
gtk-enable-primary-paste=false
gtk-toolbar-style=GTK_TOOLBAR_ICONS
gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
gtk-button-images=1
gtk-menu-images=1
gtk-enable-event-sounds=0
gtk-enable-input-feedback-sounds=0
gtk-xft-antialias=1
gtk-xft-hinting=1
gtk-xft-hintstyle=hintfull
gtk-xft-rgba=rgb
'

    OBJ_PATH="$home/.config/gtk-3.0/settings.ini"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_hostname() {
    OBJ=\
"$hostname
"

    OBJ_PATH='/etc/hostname'
    __file_write_ow_soft;
}

_hosts() {
    OBJ=\
'127.0.0.1        localhost
'
    [ ! "$ipv6" ] || OBJ=\
'::1              localhost
127.0.0.1        localhost
'

    OBJ="$OBJ"\
"127.0.1.1        $hostname
"

    OBJ_PATH='/etc/hosts'
    __file_write_ow_soft;
}

_initramfs_conf() {
    [ "$arch_linux" ] || {
        __info -white - 'Nothing to be done.'

        return 0
    }

    OBJ=\
'MODULES=()
'
    [ ! "$m533ia" ] || OBJ=\
'MODULES=(amdgpu pinctrl-amd)
'

    OBJ="$OBJ"\
'BINARIES=()
FILES=()
HOOKS=(base udev autodetect microcode modconf keyboard block filesystems fsck)
MODULES_DECOMPRESS="yes"
'

    OBJ_PATH='/etc/mkinitcpio.conf'
    __file_write_ow_soft;

    __cmd -- mkinitcpio -P
}

_iwd_conf() {
    OBJ=\
'[General]
EnableNetworkConfiguration=true
AddressRandomization=network
AddressRandomizationRange=nic

[Network]
'

    [ "$ipv6" ] && {
        OBJ="$OBJ"\
'EnableIPv6=true
'
    } || {
        OBJ="$OBJ"\
'EnableIPv6=false
'
    }

    OBJ="$OBJ"\
'NameResolvingService=none

[Scan]
DisablePeriodicScan=true
'

    OBJ_PATH='/etc/iwd/main.conf'
    __file_write_ow_soft;
}

_kitty_conf() {
    OBJ=\
'font_family Source Code Pro
font_size 10.0
cursor_text_color background
cursor_shape beam
cursor_beam_thickness 1.0
cursor_stop_blinking_after 0.0
scrollback_lines 300000
wheel_scroll_multiplier 3.0
mouse_hide_wait 0.0
url_color #FFFFFF
url_style single
select_by_word_characters -A-Za-z0-9,./?%&#:_=+@~
enable_audio_bell no
remember_window_size no
initial_window_width 814
initial_window_height 498
hide_window_decorations yes
background_opacity 0.5
update_check_interval 0
shell_integration disabled
confirm_os_window_close 0
paste_actions no-op
color0 #767676
color1 #f2201f
color2 #23fd00
color3 #fffd00
color4 #1a8fff
color5 #fd28ff
color6 #14ffff
color7 #ffffff
background #300924
map kitty_mod+a scroll_page_up
map kitty_mod+s scroll_page_down
map kitty_mod+z scroll_home
map kitty_mod+x scroll_end
'

    OBJ_PATH="$home/.config/kitty/kitty.conf"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_kvantum_conf() {
    OBJ=\
'[General]
theme=KvArcDark#
'

    OBJ_PATH="$home/.config/Kvantum/kvantum.kvconfig"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ=\
'[%General]
author=Tsu Jan
comment=A minimalistic dark theme inspired by the Arc GTK theme
x11drag=menubar_and_primary_toolbar
alt_mnemonic=true
left_tabs=true
attach_active_tab=true
mirror_doc_tabs=true
group_toolbar_buttons=false
toolbar_item_spacing=1
toolbar_interior_spacing=3
spread_progressbar=true
composite=false
menu_shadow_depth=5
menu_separator_height=6
tooltip_shadow_depth=6
splitter_width=4
scroll_width=9
scroll_arrows=false
scroll_min_extent=60
slider_width=6
slider_handle_width=18
slider_handle_length=18
center_toolbar_handle=true
check_size=14
textless_progressbar=false
progressbar_thickness=3font
menubar_mouse_tracking=true
toolbutton_style=0
click_behavior=0
translucent_windows=false
blurring=false
popup_blurring=false
vertical_spin_indicators=false
spin_button_width=32
fill_rubberband=false
merge_menubar_with_toolbar=true
small_icon_size=16
large_icon_size=32
button_icon_size=16
toolbar_icon_size=22
combo_as_lineedit=true
animate_states=false
combo_menu=true
hide_combo_checkboxes=true
combo_focus_rect=true
groupbox_top_label=true
inline_spin_indicators=false
joined_inactive_tabs=false
layout_spacing=6
layout_margin=9
scrollbar_in_view=true
transient_scrollbar=true
transient_groove=true
submenu_overlap=3
tooltip_delay=-1
tree_branch_line=true
dark_titlebar=true
contrast=1.00
dialog_button_layout=0
drag_from_buttons=false
intensity=1.00
menu_blur_radius=0
no_inactiveness=false
no_window_pattern=false
opaque=kaffeine,kmplayer,subtitlecomposer,kdenlive,vlc,smplayer,smplayer2,avidemux,avidemux2_qt4,avidemux3_qt4,avidemux3_qt5,kamoso,QtCreator,VirtualBox,VirtualBoxVM,trojita,dragon,digikam,lyx
reduce_menu_opacity=0
reduce_window_opacity=0
respect_DE=true
saturation=1.00
scrollable_menu=true
shadowless_popup=false
submenu_delay=250
tooltip_blur_radius=0

[GeneralColors]
window.color=#383c4a
base.color=#404552
alt.base.color=#3c434f
button.color=#414654
light.color=#5f677f
mid.light.color=#313131
dark.color=black
mid.color=#191919
highlight.color=#5294e2
inactive.highlight.color=#5294e2
text.color=#ffffffc8
window.text.color=#ffffffc8
button.text.color=#ffffffc8
disabled.text.color=#ffffff73
tooltip.text.color=#eefcff
highlight.text.color=white
link.color=#009DFF
link.visited.color=#9E4FFF
progress.indicator.text.color=white

[Hacks]
transparent_ktitle_label=false
transparent_dolphin_view=false
transparent_pcmanfm_sidepane=false
blur_translucent=false
transparent_menutitle=false
respect_darkness=true
force_size_grip=true
iconless_pushbutton=true
iconless_menu=false
disabled_icon_opacity=100
lxqtmainmenu_iconsize=22
normal_default_pushbutton=true
single_top_toolbar=true
tint_on_mouseover=0
transparent_pcmanfm_view=false
blur_only_active_window=false
centered_forms=false
kinetic_scrolling=false
middle_click_scroll=false
no_selection_tint=false
noninteger_translucency=false
style_vertical_toolbars=false

[PanelButtonCommand]
frame=true
frame.element=button
frame.top=3
frame.bottom=3
frame.left=3
frame.right=3
interior=true
interior.element=button
indicator.size=9
text.normal.color=#ffffffc8
text.focus.color=white
text.press.color=white
text.toggle.color=white
text.shadow=0
text.margin=1
text.iconspacing=4
indicator.element=arrow
text.margin.top=2
text.margin.bottom=2
text.margin.left=2
text.margin.right=2
min_width=+0.3font
min_height=+0.3font
frame.expansion=6

[PanelButtonTool]
inherits=PanelButtonCommand

[Dock]
inherits=PanelButtonCommand
interior.element=dock
frame.element=dock
frame.top=1
frame.bottom=1
frame.left=1
frame.right=1
text.normal.color=#ffffffc8

[DockTitle]
inherits=PanelButtonCommand
frame=false
interior=false
text.normal.color=#ffffff96
text.focus.color=white
text.bold=true

[IndicatorSpinBox]
inherits=PanelButtonCommand
frame=true
interior=true
frame.left=1
indicator.element=spin
indicator.size=10
text.normal.color=#ffffffc8

[RadioButton]
inherits=PanelButtonCommand
frame=false
interior.element=radio
text.normal.color=#ffffffc8
text.focus.color=white

[CheckBox]
inherits=PanelButtonCommand
frame=false
interior.element=checkbox
text.normal.color=#ffffffc8
text.focus.color=white

[Focus]
inherits=PanelButtonCommand
frame=true
frame.element=focus
frame.top=1
frame.bottom=1
frame.left=1
frame.right=1
frame.patternsize=20

[GenericFrame]
inherits=PanelButtonCommand
frame=true
interior=false
frame.element=common
interior.element=common
frame.top=3
frame.bottom=3
frame.left=3
frame.right=3

[LineEdit]
inherits=PanelButtonCommand
frame.element=lineedit
interior.element=lineedit
text.margin.left=1
text.margin.right=1

[DropDownButton]
inherits=PanelButtonCommand
indicator.element=arrow-down

[IndicatorArrow]
indicator.element=arrow
indicator.size=9

[ToolboxTab]
inherits=PanelButtonCommand
text.normal.color=#ffffffc8
text.press.color=#ffffff96
text.focus.color=white

[Tab]
inherits=PanelButtonCommand
interior.element=tab
text.margin.left=8
text.margin.right=8
text.margin.top=2
text.margin.bottom=2
frame.element=tab
indicator.element=tab
frame.top=4
frame.bottom=4
frame.left=4
frame.right=4
text.normal.color=#ffffff78
text.focus.color=#ffffffb4
text.toggle.color=#ffffffd2
frame.expansion=0

[TabFrame]
inherits=PanelButtonCommand
frame.element=tabframe
interior.element=tabframe
frame.top=4
frame.bottom=4
frame.left=4
frame.right=4

[TreeExpander]
inherits=PanelButtonCommand
indicator.size=12
indicator.element=tree

[HeaderSection]
inherits=PanelButtonCommand
interior.element=header
frame.element=header
frame.top=3
frame.bottom=3
frame.left=1
frame.right=1
text.bold=true
text.normal.color=#ffffff96
text.focus.color=#5796e8
text.toggle.color=white
frame.expansion=0

[SizeGrip]
indicator.element=resize-grip

[Toolbar]
inherits=PanelButtonCommand
indicator.element=toolbar
indicator.size=5
text.margin=0
frame=false
interior.element=menubar
frame.element=menubar
text.normal.color=#ffffffc8
text.focus.color=white
frame.bottom=0
frame.expansion=0

[Slider]
inherits=PanelButtonCommand
frame.element=slider
interior.element=slider
frame.top=3
frame.bottom=3
frame.left=3
frame.right=3

[SliderCursor]
inherits=PanelButtonCommand
frame=false
interior.element=slidercursor

[Progressbar]
inherits=PanelButtonCommand
frame.element=progress
interior.element=progress
text.margin=0
text.normal.color=#ffffffc8
text.focus.color=white
text.press.color=white
text.toggle.color=white
text.bold=false
frame.expansion=8

[ProgressbarContents]
inherits=PanelButtonCommand
frame=true
frame.element=progress-pattern
interior.element=progress-pattern

[ItemView]
inherits=PanelButtonCommand
text.margin=0
frame.element=itemview
interior.element=itemview
frame.top=2
frame.bottom=2
frame.left=2
frame.right=2
text.margin.top=2
text.margin.bottom=2
text.margin.left=4
text.margin.right=4
text.normal.color=#ffffffc8
text.focus.color=white
text.press.color=white
text.toggle.color=white
frame.expansion=0

[Splitter]
indicator.size=48

[Scrollbar]
inherits=PanelButtonCommand
indicator.element=arrow
indicator.size=10

[ScrollbarSlider]
inherits=PanelButtonCommand
frame.element=scrollbarslider
interior=false
frame.left=6
frame.right=6
frame.top=6
frame.bottom=6
indicator.element=grip
indicator.size=13
frame.expansion=48

[ScrollbarGroove]
inherits=PanelButtonCommand
interior=false
frame=false

[MenuItem]
inherits=PanelButtonCommand
frame=true
frame.element=menuitem
interior.element=menuitem
indicator.element=menuitem
text.normal.color=#ffffffc8
text.focus.color=white
text.margin.top=1
text.margin.bottom=1
text.margin.left=15
text.margin.right=5
frame.top=3
frame.bottom=3
frame.left=3
frame.right=3
frame.expansion=0

[MenuBar]
inherits=PanelButtonCommand
frame.element=menubar
interior.element=menubar
frame.bottom=0
frame.expansion=0

[MenuBarItem]
inherits=PanelButtonCommand
interior=true
interior.element=menubaritem
frame.element=menubaritem
frame.top=2
frame.bottom=2
frame.left=2
frame.right=2
text.margin.left=4
text.margin.right=4
text.margin.top=0
text.margin.bottom=0
text.normal.color=#000000b4
text.focus.color=white
frame.expansion=0

[TitleBar]
inherits=PanelButtonCommand
frame=false
interior.element=titlebar
indicator.size=12
indicator.element=mdi
text.normal.color=#787878
text.focus.color=white
text.bold=true
text.italic=true
frame.expansion=0

[ComboBox]
inherits=PanelButtonCommand
interior.element=combo
frame.element=combo
text.press.color=#ffffffc8
indicator.element=carrow

[Menu]
inherits=PanelButtonCommand
frame.top=1
frame.bottom=1
frame.left=1
frame.right=1
frame.element=menu
interior.element=menu
text.normal.color=#ffffffc8
text.shadow=false
frame.expansion=0

[GroupBox]
inherits=GenericFrame
frame=false
text.shadow=0
text.margin=0
text.normal.color=#ffffff96
text.focus.color=white
text.bold=true
frame.expansion=0

[TabBarFrame]
inherits=GenericFrame
frame=true
frame.element=tabBarFrame
interior=false
frame.top=4
frame.bottom=4
frame.left=4
frame.right=4

[ToolTip]
inherits=GenericFrame
frame.top=3
frame.bottom=3
frame.left=3
frame.right=3
interior=true
text.shadow=0
text.margin=0
interior.element=tooltip
frame.element=tooltip
frame.expansion=0

[StatusBar]
inherits=GenericFrame
frame=false
interior=false

[Window]
interior=true
interior.element=window
'

    OBJ_PATH="$home/.config/Kvantum/KvArcDark#/KvArcDark#.kvconfig"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

# English locale config
_locale() {
    OBJ=\
'LANG=en_US.UTF-8
'

    OBJ_PATH='/etc/locale.conf'
    __file_write_ow_soft;

    OBJ=\
'bg_BG.UTF-8 UTF-8
en_US.UTF-8 UTF-8
'

    OBJ_PATH='/etc/locale.gen'
    __file_write_ow_soft;

    __cmd -- locale-gen
}

_makepkg_conf() {
    [ "$arch_linux" ] || {
        __info -white - 'Nothing to be done.'

        return 0
    }

    OBJ=
    OBJ_PATH='/etc/makepkg.conf'
    __ed -log "${TMPDIR:-/tmp}/_makepkg_conf" -- \
        -m p -s \
        'CFLAGS="-march=x86-64 -mtune=' \
        'CFLAGS="-march=x86-64 -mtune=native -O2 -pipe -fno-plt -fexceptions \' \
        -s \
        'MAKEFLAGS="-j' \
        'MAKEFLAGS="-j6"' \
        -m p -s \
        'OPTIONS=(strip docs !libtool !staticlibs emptydirs zipman purge ' \
        'OPTIONS=(strip docs !libtool !staticlibs emptydirs zipman purge !debug lto)'

    OBJ="$OBJ"
    OBJ_PATH='/etc/makepkg.conf'
    __file_write_ow_soft -color -log "${TMPDIR:-/tmp}/_makepkg_conf" -sanit \
        -trunc
}

_moc_conf() {
    OBJ=\
'SoundDriver = ALSA
Theme = transparent-background
'

    OBJ_PATH="$home/.moc/config"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

# Fix pop on idle resume
_modprobe_conf() {
    OBJ=\
'options snd_hda_intel power_save=0 power_save_controller=N
'

    OBJ_PATH='/etc/modprobe.d/99-snd_powersave.conf'
    __file_write_ow_soft;
}

_mpv_conf() {
    OBJ=\
'# UI & Appearance (nonGPU)
fullscreen
border=no               # no window border
msg-color=yes           # colored terminal output
cursor-autohide=1000    # hide cursor after 1s of inactivity

# Session
save-position-on-quit=yes

# Language & Subtitles
alang=en
slang=en
sub-auto=fuzzy
sub-bold=yes

# HW / Performance
# Named profile for performance on Ryzen low-end APUs
# 0 frame drops on 4k60fps+HDR
[performance]  # Additional target is compatiblity
hwdec=vaapi  # compat
vo=gpu  # compat
interpolation=no  # compat; interpolation causes frame glitches here
hdr-compute-peak=no  # compat; reported to break certain drivers
scale=bilinear  # Fast, 2tap linear filter; exact when no resizing
cscale=bilinear  # Same for chroma; avoids heavier chroma filters
dither-depth=8  # 8bpc output (matches most SDR displays; cuts shader work)
tone-mapping=clip  # Hardclip outofrange HDR values; zero shader overhead
video-sync=audio  # Let compositor handle any pacing mismatch / "judder"

# Named profile for quality on Ryzen low-end APUs
# Overlay on top of [performance] for anything FHD and below
# 0 frame drops
[quality]
hdr-peak-percentile=99.995  # gpu-hq/high-quality default
hdr-contrast-recovery=0.30  # gpu-hq/high-quality default
scale=ewa_lanczossharp  # gpu-hq/high-quality default
'

    OBJ_PATH="$home/.config/mpv/mpv.conf"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ=\
'-- Apply 4K or FHD profiles once on file-load, then never reapply on seek.

local applied = false

mp.register_event("file-loaded", function()
    applied = false
end)

mp.observe_property("video-params/w", "number", function(_, w)
    if not applied and w then
        if w >= 3840 then
            mp.command("apply-profile performance")
            mp.osd_message("Profile: 4K (performance)", 1.5)
        elseif w <= 1920 then
            mp.command("apply-profile performance")
            mp.command("apply-profile quality")
            mp.osd_message("Profile: 1080p (performance+quality)", 1.5)
        end
        applied = true
    end
end)
'

    OBJ_PATH="$home/.config/mpv/scripts/autoprofile.lua"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_mutt_conf() {
    OBJ=\
'# Personal
set realname = "Dimitar Yurukov"
set from = "mscalindt@gmail.com"

# SMTP
set smtp_url = "smtps://mscalindt@smtp.gmail.com"
set ssl_force_tls = yes

# IMAP
set imap_user = "mscalindt@gmail.com"
set folder = "imaps://imap.gmail.com"
set spoolfile = "imaps://imap.gmail.com/INBOX"

# Settings
set signature="~/.mutt/muttsig"
set send_charset="us-ascii:utf-8"
set charset = UTF-8
set edit_headers = yes
set use_from = yes
set envelope_from = yes
unset use_domain

# Keybindings
bind index "^" imap-fetch-mail
'

    OBJ_PATH="$home/.mutt/muttrc"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ=\
'PGP: https://github.com/mscalindt.gpg
Email: mscalindt@gmail.com
'

    OBJ_PATH="$home/.mutt/muttsig"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_nano_conf() {
    OBJ=\
'set fill 72
set breaklonglines
'

    OBJ_PATH="$home/.nanorc"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

# Delete all boot entries (UEFI)
_nvram_clr() {
    set -- '/sys/firmware/efi/efivars'/Boot0*

    [ -e "$1" ] || {
        __info -white - 'No valid entries have been found.'

        return 0
    }

    set -- \
        '/sys/firmware/efi/efivars'/BootOrder* \
        '/sys/firmware/efi/efivars'/Boot0*

    { ! command -v chattr; } || {
        __cmd -- chattr -ia "$@"
    }

    __cmd -- rm -f "$@"

    __info -white - 'The entries were removed; firmware will attempt recovery.'
}

_openal_conf() {
    OBJ=\
'frequency = 44100
'

    OBJ_PATH='/etc/openal/alsoft.conf'
    __file_write_ow_soft;
}

_pacman_conf() {
    [ "$arch_linux" ] || {
        __info -white - 'Nothing to be done.'

        return 0
    }

    OBJ=
    OBJ_PATH='/etc/pacman.conf'
    __ed -log "${TMPDIR:-/tmp}/_pacman_conf" -- \
        -m s -s \
        'Color' \
        'Color' \
        -s \
        'ParallelDownloads' \
        'ParallelDownloads = 5' \
        -m s -s \
        'VerbosePkgLists' \
        'VerbosePkgLists' \
        -s \
        'NoExtract' \
        'NoExtract = etc/xdg/autostart/*.desktop'

    OBJ="$OBJ"
    __ed -crc 2066821928 -log "${TMPDIR:-/tmp}/_pacman_conf" -- \
        -m s -s \
        '[multilib]' \
        '[multilib]' \
        -m 93 -s \
        '' \
        "Include = $arch_mirlist"

    OBJ="$OBJ"
    OBJ_PATH='/etc/pacman.conf'
    __file_write_ow_soft -color -log "${TMPDIR:-/tmp}/_pacman_conf" -sanit \
        -trunc
}

_pam_conf() {
    OBJ=\
'deny=7
even_deny_root
nodelay
root_unlock_time=8400
unlock_time=600
'

    OBJ_PATH='/etc/security/faillock.conf'
    __file_write_ow_soft;

    OBJ=
    OBJ_PATH='/etc/login.defs'
    __ed -log "${TMPDIR:-/tmp}/_pam_conf" -- \
        -m p -s \
        'FAIL_DELAY' \
        'FAIL_DELAY 0'

    OBJ="$OBJ"
    OBJ_PATH='/etc/login.defs'
    __file_write_ow_soft -color -log "${TMPDIR:-/tmp}/_pam_conf" -sanit -trunc

    OBJ=
    OBJ_PATH='/etc/pam.d/su'
    __ed -crc 3615679525 -log "${TMPDIR:-/tmp}/_pam_conf" -- \
        -m 7 -s \
        '' \
        'auth            required        pam_unix.so nodelay'

    OBJ="$OBJ"
    OBJ_PATH='/etc/pam.d/su'
    __file_write_ow_soft -color -log "${TMPDIR:-/tmp}/_pam_conf" -sanit -trunc

    OBJ=
    OBJ_PATH='/etc/pam.d/system-auth'
    __ed -crc 1797369364 -log "${TMPDIR:-/tmp}/_pam_conf" -- \
        -m mof -m s -s \
        'try_first_pass nullok' \
        'try_first_pass nullok nodelay'

    OBJ="$OBJ"
    OBJ_PATH='/etc/pam.d/system-auth'
    __file_write_ow_soft -color -log "${TMPDIR:-/tmp}/_pam_conf" -sanit -trunc
}

_pipewire_conf() {
    OBJ=\
'context.properties = {
    module.rt = false  # disable rtkit module

    mem.allow-mlock = false  # swap is not used -> mlock is useless overhead

    default.clock.quantum-limit = 8192
}

filter.properties = {
    node.latency = 1024/44100  # 44.1k with ~23.2ms
}

stream.properties = {
    node.latency = 1024/44100  # 44.1k with ~23.2ms
'

    [ "$audio_hq_resamp" ] && {
        OBJ="$OBJ"\
'    resample.quality = 15
'
    } || {
        OBJ="$OBJ"\
'    resample.quality = 9
'
    }

    OBJ="$OBJ"\
'}

alsa.properties = {
    alsa.rate = 44100  # 44.100 kHz
}
'

    OBJ_PATH='/etc/pipewire/client.conf.d/client.conf'
    __file_write_ow_soft;

    OBJ=\
'context.properties = {
    module.rt = false  # disable rtkit module
    module.x11.bell = false  # disable x11 bell module
'

    [ "$portal" ] || OBJ="$OBJ"\
'
    module.portal = false  # disable portal module
'

    OBJ="$OBJ"\
'
    mem.allow-mlock = false  # swap is not used -> mlock is useless overhead

    loop.rt-prio = 0  # disable module-rt prio

    # 44.1k with ~23.2ms; related limits noted for explicit config
    default.clock.rate = 44100
    default.clock.allowed-rates = [ 44100 ]
    default.clock.quantum = 1024
    default.clock.min-quantum = 32
    default.clock.max-quantum = 2048
    default.clock.quantum-limit = 8192
    default.clock.quantum-floor = 4
}
'

    OBJ_PATH='/etc/pipewire/pipewire.conf.d/pipewire.conf'
    __file_write_ow_soft;

    OBJ=\
'context.properties = {
    mem.allow-mlock = false  # swap is not used -> mlock is useless overhead

    default.clock.quantum-limit = 8192
}

pulse.properties = {
    pulse.allow-module-loading = false  # we use no modules
    # 44.1k with ~23.2ms
    pulse.min.req = 128/44100  # ~2.9ms
    pulse.default.req = 1024/44100  # ~23.2ms
    pulse.min.frag = 128/44100  # ~2.9ms
    pulse.default.frag = 88200/44100  # 2s
    pulse.default.tlength = 88200/44100  # 2s
    pulse.min.quantum = 128/44100  # ~2.9ms
    pulse.idle.timeout = 0  # I guess disables suspend functionality
}

stream.properties = {
    node.latency = 1024/44100  # 44.1k with ~23.2ms
'

    [ "$audio_hq_resamp" ] && {
        OBJ="$OBJ"\
'    resample.quality = 15
'
    } || {
        OBJ="$OBJ"\
'    resample.quality = 9
'
    }

    OBJ="$OBJ"\
'}
'

    OBJ_PATH='/etc/pipewire/pipewire-pulse.conf.d/pipewire-pulse.conf'
    __file_write_ow_soft;
}

_pipewire_media_session_conf() {
    OBJ=\
'context.properties = {
    support.dbus = true
    default-profile.restore-bluetooth = true
}

context.spa-libs = {
    api.bluez5.*    = bluez5/libspa-bluez5
    api.alsa.*      = alsa/libspa-alsa
    api.v4l2.*      = v4l2/libspa-v4l2
    api.libcamera.* = libcamera/libspa-libcamera
}

context.modules = [
    { name = libpipewire-module-protocol-native }
    { name = libpipewire-module-client-node }
    { name = libpipewire-module-client-device }
    { name = libpipewire-module-adapter }
    { name = libpipewire-module-metadata }
    { name = libpipewire-module-session-manager }
]

session.modules = {
    default = [
        alsa-monitor
        alsa-seq
        default-nodes
        default-profile
        default-routes
        metadata
        policy-node
        restore-stream
        streams-follow-default
        v4l2
'

    [ ! "$bluetooth" ] || OBJ="$OBJ"\
'        bluez5
        bluez5-autoswitch
'

    [ ! "$bluetooth" ] || OBJ="$OBJ"\
'        portal
'

    OBJ="$OBJ"\
'    ]
}
'

    OBJ_PATH='/etc/pipewire/media-session.d/media-session.conf'
    __file_write_ow_soft;

    OBJ=\
'properties = {
    bluez5.enable-sbc-xq = false
    bluez5.enable-msbc = false
    bluez5.enable-hw-volume = true
    bluez5.enable-faststream = false

    bluez5.codecs = [ aac ]

    bluez5.default.rate = 44100  # 44.100 kHz
}

rules = [
    {
        matches = [
            {
                device.name = "~bluez_card.*"
            }
        ]
        actions = {
            update-props = {
                bluez5.auto-connect = [ a2dp_sink ]
                bluez5.a2dp.aac.bitratemode = 0  # CBR 256 kbps
                bluez5.profile = a2dp-sink
                bluez5.autoswitch-profile = false
            }
        }
    }
    {
        matches = [
            {
                node.name = "~bluez_input.*"
            }
            {
                node.name = "~bluez_output.*"
            }
        ]
        actions = {
            update-props = {
                node.pause-on-idle = false
'

    [ "$audio_hq_resamp" ] && {
        OBJ="$OBJ"\
'                resample.quality = 15
'
    } || {
        OBJ="$OBJ"\
'                resample.quality = 9
'
    }

    OBJ="$OBJ"\
'                session.suspend-timeout-seconds = 0
                bluez5.media-source-role = playback
            }
        }
    }
]
'

    [ ! "$bluetooth" ] || {
        OBJ_PATH='/etc/pipewire/media-session.d/bluez-monitor.conf'
        __file_write_ow_soft;
    }
}

_ranger_conf() {
    OBJ=\
'map D console delete
copymap J <C-z>
copymap K <C-x>
copymap S <C-s>
set autosave_bookmarks false
set display_free_space_in_status_bar false
set display_size_in_status_bar false
set draw_borders both
set hostname_in_titlebar false
set idle_delay 100
set max_console_history_size 100
set mouse_enabled false
set preview_images_method kitty
set tilde_in_titlebar true
'

    OBJ_PATH="$home/.config/ranger/rc.conf"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ=\
'# Video
mime ^video, has mpv,       X,  flag f = mpv -- "$@"
mime ^video, has parole,    X,  flag f = parole -- "$@"
mime ^video, has vlc,       X,  flag f = vlc -- "$@"
mime ^video, has mpv,       !X, terminal = mpv -- "$@"

# Audio
ext midi?, has wildmidi,    terminal = wildmidi -- "$@"
mime ^audio, has mocp,      terminal = mocp -l -- "$@"
mime ^audio, has mpv,       terminal = mpv -- "$@"
mime ^audio, has parole,    X, flag f = parole -- "$@"
mime ^audio, has vlc,       X, flag f = vlc -- "$@"

# Images
ext xcf, has gimp,                X, flag f = gimp -- "$@"
mime ^image/svg, has inkscape,    X, flag f = inkscape -- "$@"
mime ^image/svg, has display,     X, flag f = display -- "$@"
mime ^image, has swayimg,         X, flag f = swayimg -- "$@"
mime ^image, has imv,             X, flag f = imv -- "$@"
mime ^image, has ristretto,       X, flag f = ristretto "$@"
mime ^image, has gimp,            X, flag f = gimp -- "$@"

# PDF/Books
ext pdf, has firefox,          X, flag f = firefox -- "$@"
ext pdf, has zathura,          X, flag f = zathura -- "$@"
ext djvu, has zathura,         X, flag f = zathura -- "$@"
ext djvu, has djview,          X, flag f = djview -- "$@"
ext epub, has zathura,         X, flag f = zathura -- "$@"
ext epub, has ebook-viewer,    X, flag f = ebook-viewer -- "$@"
ext mobi, has ebook-viewer,    X, flag f = ebook-viewer -- "$@"
ext cbr|cbz, has zathura,      X, flag f = zathura -- "$@"

# Archives (atool)
ext 7z|ace|ar|arc|bz2?|cab|cpio|cpt|deb|dgc|dmg|gz|iso|jar|msi|pkg|rar|shar|tar|tgz|xar|xpi|xz|zip,    has atool = atool --list --each -- "$@" | "$PAGER"
ext 7z|ace|ar|arc|bz2?|cab|cpio|cpt|deb|dgc|dmg|gz|iso|jar|msi|pkg|rar|shar|tar|tgz|xar|xpi|xz|zip,    has atool = atool --extract --each -- "$@"

# Archives
ext 7z      has 7z = 7z -p l "$@" | "$PAGER"
ext 7z,     has 7z = for file in "$@"; do 7z -p -o"${file%???}" x -- "$file"; done
ext ace,    has unace = unace l "$1" | less
ext ace,    has unace = for file in "$@"; do unace e "$file"; done
ext bz2,    has tar = tar vvtf "$1" | "$PAGER"
ext bz2,    has tar = for file in "$@"; do tar vvxf "$file"; done
ext bz2,    has bzip2 = for file in "$@"; do bzip2 -dk "$file"; done
ext gz,     has tar = tar vvtf "$1" | "$PAGER"
ext gz,     has tar = for file in "$@"; do tar vvxf "$file"; done
ext rar,    has unrar = unrar l "$1" | less
ext rar,    has unrar = for file in "$@"; do unrar x "$file"; done
ext tar,    has tar = tar vvtf "$1" | "$PAGER"
ext tar,    has tar = for file in "$@"; do tar vvxf "$file"; done
ext xz,     has tar = tar vvtf "$1" | "$PAGER"
ext xz,     has tar = for file in "$@"; do tar vvxf "$file"; done
ext zip,    has unzip = unzip -l "$1" | less
ext zip,    has unzip = for file in "$@"; do unzip -d "${file%.*}" "$file"; done
ext zst,    has tar = tar vvtf "$1" | "$PAGER"
ext zst,    has tar = for file in "$@"; do tar vvxf "$file"; done

# HTML
ext x?html?, has firefox,     X, flag f = firefox -- "$@"
ext x?html?, has midori,      X, flag f = midori -- "$@"
ext x?html?, has chromium,    X, flag f = midori -- "$@"

# Docs/Text
ext sh,    has featherpad,     X, flag f = featherpad "$@"
ext shfn,  has featherpad,     X, flag f = featherpad "$@"
ext ini,   has featherpad,     X, flag f = featherpad "$@"
ext docx?, has catdoc,         terminal = catdoc -- "$@" | "$PAGER"
mime ^text, has featherpad,    X, flag f = featherpad "$@"
mime ^text, label editor                 = "${VISUAL:-$EDITOR}" -- "$@"
mime ^text, label pager                  = "$PAGER" -- "$@"

# Misc exts
ext 1|5 = man "$1"
ext exe = wine "$1"

# Misc mEmes
mime application/x-executable               = "$1"
mime ^font, has fontforge, X, flag f        = fontforge "$@"
mime ^ranger/x-terminal-emulator, has kitty = kitty -- "$@"

label open,   has xdg-open = xdg-open "$@"
label editor, !mime ^text, = "${VISUAL:-$EDITOR}" -- "$@"
label pager,  !mime ^text, = "$PAGER" -- "$@"
'

    OBJ_PATH="$home/.config/ranger/rifle.conf"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_reflector() {
    [ "$arch_linux" ] || {
        __info -white - 'Nothing to be done.'

        return 0
    }

    [ "$bg" ] && {
        __cmd -req-out -out-save OBJ -- \
            reflector \
            --country Bulgaria \
            --connection-timeout 1 \
            --download-timeout 20 \
            --protocol https \
            --completion-percent 100 \
            --sort rate \
            --threads 8 \
            --latest 10 \
            --number 3
    } || [ "$de" ] && {
        __cmd -req-out -out-save OBJ -- \
            reflector \
            --country Germany \
            --connection-timeout 1 \
            --download-timeout 60 \
            --protocol https \
            --completion-percent 100 \
            --sort rate \
            --threads 8 \
            --latest 15 \
            --number 3
    } || {
        __info -white - 'Nothing to be done.'

        return 0
    }

    OBJ="$OBJ"
    __ed -- \
        -m mof -m p -s \
        'Server =' \
        'Server =' \
        -r '' \
        - ''

    OBJ="$OBJ"
    OBJ_PATH="$arch_mirlist"
    __file_write_ow_soft;
}

_resolv_conf() {
    [ "$dns" ] && {
        OBJ=\
'nameserver 127.0.0.1
'
        [ ! "$ipv6" ] || OBJ=\
'nameserver ::1
nameserver 127.0.0.1
'

        [ ! "$dns0" = dnsmasq ] || OBJ="$OBJ"\
'options trust-ad
'

        OBJ_PATH='/etc/resolv.conf'
        __file_write_ow_soft;

        { ! command -v chattr; } || {
            __cmd -- chattr +i '/etc/resolv.conf'
        }
    } || {
        OBJ_PATH='/etc/resolv.conf'
        __action -del
    }
}

_sh() {
    OBJ='/usr/bin/dash'
    OBJ_PATH='/usr/bin/sh'
    __obj_link_ow_soft;

    [ "$arch_linux" ] && {
        OBJ=\
'[Trigger]
Type = Package
Operation = Install
Operation = Upgrade
Target = bash

[Action]
Description = Updating /bin/sh symlink to dash...
When = PostTransaction
Exec = /usr/bin/ln -sf /usr/bin/dash /usr/bin/sh
Depends = dash
'

        OBJ_PATH='/usr/share/libalpm/hooks/dashbinsh.hook'
        __file_write_ow_soft;
    } || {
        OBJ_PATH='/usr/share/libalpm/hooks/dashbinsh.hook'
        __action -del
    }
}

_sudo_conf() {
    OBJ=\
'%wheel ALL=(ALL:ALL) ALL
'

    OBJ_PATH='/etc/sudoers.d/wheel'
    __file_write_ow_soft -mode 0440
}

_sway_conf() {
    OBJ=\
'output * adaptive_sync off
output * allow_tearing yes
output * max_render_time off

# Mod4 = Super key
set $mod Mod4
set $term kitty
set $menu exec \
    $term --class=sway-app-launcher \
    /usr/bin/sway-launcher-desktop

focus_follows_mouse always

# Prevent annoying apps from disrupting active focus by pinning them to a
# certain workplace, in our case `7`, used as a last resort workspace or "bag".
# Steam'\''s "launcher"
assign [title="Steam"] 7
# Steam
assign [class="steam"] 7

# Pin specific apps to specific workspaces.
# FeatherPad
assign [app_id="featherpad"] 2

for_window [app_id="sway-app-launcher"] \
    floating enable, sticky enable, resize set 30 ppt 60 ppt, border pixel 5
for_window [app_id="firefox"] \
    border none

input type:touchpad {
    dwt disabled
    tap enabled
}

input type:keyboard {
    xkb_layout us,bg(phonetic)
    xkb_model pc86
    xkb_options grp:alt_shift_toggle,caps:super
    repeat_delay 222
    repeat_rate 50
}

# Disable mouse acceleration
input * {
    accel_profile flat
}

# Appearance {
    output * bg #241f31 solid_color
    default_border pixel
    client.focused #0A75AD #0A75AD #0A75AD #0A75AD #0A75AD
    font pango:Cantarell 12
    seat seat0 xcursor_theme Breeze
    exec_always /home/$USER/.config/sway/import-gsettings
    exec_always /home/$USER/.config/sway/wp-handler
# }

# App keybindings {
    bindsym $mod+Return exec $term
    bindsym $mod+a exec $menu
    bindsym $mod+t exec /usr/bin/Telegram
    bindsym $mod+b exec /usr/bin/blueman-manager
# }

# Control keybindings {
    bindsym $mod+1 workspace number 1
    bindsym $mod+2 workspace number 2
    bindsym $mod+3 workspace number 3
    bindsym $mod+4 workspace number 4
    bindsym $mod+5 workspace number 5
    bindsym $mod+6 workspace number 6
    bindsym $mod+7 workspace number 7

    bindsym $mod+Left focus left
    bindsym $mod+Down focus down
    bindsym $mod+Up focus up
    bindsym $mod+Right focus right
    bindsym Alt+Tab focus right
    bindsym Alt+Shift+Tab focus left

    # Basic functions
    bindsym $mod+z exec pamixer -d5
    bindsym $mod+x exec pamixer -i5
    bindsym $mod+c exec brightnessctl s 5%-
    bindsym $mod+v exec brightnessctl s 5%+
    bindsym print exec grim -l 9 $(date +'\''SS_%Y%m%d_%H%M%S.png'\'')
    bindsym $mod+p exec grim -l 9 -g "$(slurp)" \
                            $(date +'\''SS_%Y%m%d_%H%M%S.png'\'')
    bindsym $mod+Shift+p exec grim -l 9 -g "$(slurp; sleep 2.5)" \
                                  $(date +'\''SS_%Y%m%d_%H%M%S.png'\'')

    # Extended functions
    # get hex color of a pixel
    bindsym $mod+h exec grim -g "$(slurp -p)" -t ppm - | \
                        convert - -format '\''%[pixel:p{0,0}]'\'' txt:- | \
                        tail -n 1 | cut -d '\'' '\'' -f 4 | wl-copy -n
    # toggle audio playback
    bindsym $mod+Space exec /home/$USER/.config/sway/music_toggle

    # Kill window
    bindsym $mod+q kill

    # Force kill window
    bindsym $mod+Shift+q exec /home/$USER/.config/sway/fkill

    # Fullscreen window
    bindsym $mod+f fullscreen

    # Drag window by holding down $mod + LMB
    # Resize window by holding down $mod + RMB
    floating_modifier $mod normal

    # Invoke swaylock
    bindsym $mod+l exec swaylock

    # Reload the config
    bindsym $mod+Shift+c reload
# }

mode "nointercept" {
    bindsym $mod+Escape mode "default"
}
bindsym $mod+Shift+Escape mode "nointercept"

bar {
    status_command while /home/$USER/.config/sway/status; do sleep 0.1; done
    position top
    font pango:Source Code Pro 10

    colors {
        statusline #ffffff
        background #2b2e37
        inactive_workspace #32323200 #32323200 #5c5c5c
    }
}

'

    [ ! "$arch_linux" ] || OBJ="$OBJ"\
'exec /home/$USER/.config/sway/systemd-handler
'

    OBJ="$OBJ"\
'exec_always sh -c '\''rm -f "${TMPDIR:-/tmp}"/nettotal'\''
'

    OBJ_PATH="$home/.config/sway/config"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ=\
'#!/bin/sh

PID=$(
    swaymsg -t get_tree | \
    jq '\''.. | select(.type?) | select(.focused==true).pid'\''
)

kill -9 "$PID"
'

    OBJ_PATH="$home/.config/sway/fkill"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group" \
        -mode 0755

    OBJ=\
'#!/bin/sh

cfg="${XDG_CONFIG_HOME:-$HOME/.config}/gtk-3.0/settings.ini"

[ -f "$cfg" ] || return 1

gnome_schema='\''org.gnome.desktop.interface'\''

while read -r LINE; do
    case "$LINE" in
        '\''gtk-theme-name='\''*)
            gsettings set "$gnome_schema" gtk-theme "${LINE#*=}"
        ;;
        '\''gtk-icon-theme-name='\''*)
            gsettings set "$gnome_schema" icon-theme "${LINE#*=}"
        ;;
        '\''gtk-cursor-theme-name='\''*)
            gsettings set "$gnome_schema" cursor-theme "${LINE#*=}"
        ;;
        '\''gtk-font-name='\''*)
            gsettings set "$gnome_schema" font-name "${LINE#*=}"
        ;;
        '\''#gtk-document-font-name='\''*)
            gsettings set "$gnome_schema" document-font-name "${LINE#*=}"
        ;;
        '\''#gtk-monospace-font-name='\''*)
            gsettings set "$gnome_schema" monospace-font-name "${LINE#*=}"
        ;;
        '\''gtk-application-prefer-dark-theme='\''*true*)
            gsettings set "$gnome_schema" color-scheme prefer-dark
        ;;
    esac
done < "$cfg"
'

    OBJ_PATH="$home/.config/sway/import-gsettings"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group" \
        -mode 0755

    OBJ=\
'#!/bin/sh

MOCP_STATE=$(mocp -Q %state)
MOCP_PAUSE_FILE="${TMPDIR:-/tmp}"/music_toggle_mocp

if [ -f "$MOCP_PAUSE_FILE" ]; then
    if playerctl status 2> /dev/null | grep -q '\''Playing'\''; then
        playerctl play-pause
    elif [ "$MOCP_STATE" = '\''PAUSE'\'' ]; then
        mocp -U
    fi

    rm -f "$MOCP_PAUSE_FILE"
    exit 0
elif [ "$MOCP_STATE" = '\''PLAY'\'' ]; then
    mocp -P
    : > "$MOCP_PAUSE_FILE"
    exit 0
fi

playerctl play-pause > /dev/null 2>&1
'

    OBJ_PATH="$home/.config/sway/music_toggle"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group" \
        -mode 0755

    OBJ=\
'#!/bin/sh

NET_INTERFACE=wlan0

replchars() {
    replchar() {
        IFS="$1"; _chars="$2"

        set -f; set -- $3 "$3"; set +f

        _str=; while [ "$#" -ge 3 ]; do
            _str="$_str$1$_chars"; shift
        done

        case "$IFS" in
            *"${2#"${2%?}"}"*) _str="$_str$1$_chars" ;;
            *) _str="$_str$1" ;;
        esac
    }

    _old_IFS="$IFS" 2> /dev/null
    ${IFS+'\'':'\''} unset _old_IFS 2> /dev/null

    replchar "$1" "$2" "$3"

    IFS="$_old_IFS" 2> /dev/null
    ${_old_IFS+'\'':'\''} unset IFS 2> /dev/null
}

TITLE=$(
    swaymsg -t get_tree | \
    jq -r '\''.. | select(.type?) | select(.focused==true).name'\'' 2> /dev/null
)
if [ "$TITLE" ]; then
    replchars '\''&'\'' '\''&amp;'\'' "$TITLE"; TITLE="$_str"
    replchars '\''<'\'' '\''&lt;'\'' "$TITLE"; TITLE="$_str"
    replchars '\''>'\'' '\''&gt;'\'' "$TITLE"; TITLE="$_str"
fi

MEMHOG=$(ps aux 2> /dev/null)
{
CUR=
CUR_F_PERC=
CUR_S_PERC=
while IFS= read -r LINE; do
    set -- $LINE

    case "$4" in
        '\''%MEM'\'') continue ;;
    esac

    f_perc="${4%.*}"
    s_perc="${4#*.}"

    if [ "$CUR_F_PERC" ]; then
        if [ "$f_perc" -gt "$CUR_F_PERC" ]; then
            CUR="$LINE"
            CUR_F_PERC="$f_perc"
            CUR_S_PERC="$s_perc"
        elif [ "$f_perc" -eq "$CUR_F_PERC" ]; then
            if [ "$s_perc" -gt "$CUR_S_PERC" ]; then
                CUR="$LINE"
                CUR_S_PERC="$s_perc"
            fi
        fi
    else
        CUR="$LINE"
        CUR_F_PERC="$f_perc"
        CUR_S_PERC="$s_perc"
    fi
done \
<<EOF
$MEMHOG
EOF

read -r _ MEMTOTAL_BYTES _ < /proc/meminfo
MEMTOTAL_BYTES=$((MEMTOTAL_BYTES * 1024))

MEMHOG=$(
    set -- $CUR
    printf "%s" "$2 /"  # pid

    CUR="${CUR#*/}"
    set -- $CUR
    printf "%s" "${1##*/} /"  # cmd

    MEMHOG_BYTES=$((MEMTOTAL_BYTES * $CUR_F_PERC$CUR_S_PERC / 1000))  # base 2
    awk -v '\''bytes_memhog'\''="$MEMHOG_BYTES" '\''
	function hsize(x, base) {
		basesuf = (base == "1024") ? "iB" : "B"

		s = "BKMGTEPYZ"
		while (x >= base && length(s) > 1)
			{x /= base; s = substr(s, 2)}
		s = substr(s, 1, 1)

		xf = (s == "B") ? "%d" : "%.2f"

		if (s != "B")
			s = s basesuf

		printf((xf " %s"), x, s)
	}

	BEGIN {
		printf hsize(bytes_memhog, 1000)
	}
    '\''  # mem_usage
)
} 2> /dev/null

while :; do
NET_USAGE=
if [ -h /sys/class/net/"$NET_INTERFACE" ]; then
    PREV_TX=0
    PREV_RX=0
    TOTAL=0
    if [ -f "${TMPDIR:-/tmp}"/netprevtx ]; then
        read -r PREV_TX < "${TMPDIR:-/tmp}"/netprevtx
    fi
    if [ -f "${TMPDIR:-/tmp}"/netprevrx ]; then
        read -r PREV_RX < "${TMPDIR:-/tmp}"/netprevrx
    fi
    if [ -f "${TMPDIR:-/tmp}"/nettotal ]; then
        read -r TOTAL < "${TMPDIR:-/tmp}"/nettotal
    fi
    read -r TX < /sys/class/net/"$NET_INTERFACE"/statistics/tx_bytes
    read -r RX < /sys/class/net/"$NET_INTERFACE"/statistics/rx_bytes
    [ "$TX" ] || break
    [ "$RX" ] || break

    if [ "$PREV_TX" = 0 ]; then
        printf "%s\n" "$TX" > "${TMPDIR:-/tmp}"/netprevtx; TX=0
    else
        CUR_TX=$((TX - PREV_TX))
    fi

    if [ "$PREV_RX" = 0 ]; then
        printf "%s\n" "$RX" > "${TMPDIR:-/tmp}"/netprevrx; RX=0
    else
        CUR_RX=$((RX - PREV_RX))
    fi

    if [ "$TX" = 0 ] || [ "$RX" = 0 ]; then
        break
    fi

    TOTAL=$((TOTAL + (CUR_TX + CUR_RX)))

    printf "%s\n" "$TX" > "${TMPDIR:-/tmp}"/netprevtx
    printf "%s\n" "$RX" > "${TMPDIR:-/tmp}"/netprevrx
    printf "%s\n" "$TOTAL" > "${TMPDIR:-/tmp}"/nettotal

    NET_USAGE=$(awk -v '\''bytes_tx'\''="$CUR_TX" -v '\''bytes_rx'\''="$CUR_RX" \
                    -v '\''bytes_total'\''="$TOTAL" '\''
	function hsize(x, base) {
		basesuf = (base == "1024") ? "iB" : "B"

		s = "BKMGTEPYZ"
		while (x >= base && length(s) > 1)
			{x /= base; s = substr(s, 2)}
		s = substr(s, 1, 1)

		xf = (s == "B") ? "%d" : "%.2f"

		if (s != "B")
			s = s basesuf

		printf((xf " %s"), x, s)
	}

	BEGIN {
		printf "UDT"
		printf " /"
		printf hsize(bytes_tx, 1000)
		printf " /"
		printf hsize(bytes_rx, 1000)
		printf " /"
		printf hsize(bytes_total, 1000)
	}
    '\'' 2> /dev/null)
fi
break; done

PREV_IDLE=0
PREV_TOTAL=0
if [ -f "${TMPDIR:-/tmp}"/cpustatprevi ]; then
    read -r PREV_IDLE < "${TMPDIR:-/tmp}"/cpustatprevi
fi
if [ -f "${TMPDIR:-/tmp}"/cpustatprevt ]; then
    read -r PREV_TOTAL < "${TMPDIR:-/tmp}"/cpustatprevt
fi
read -r line < /proc/stat
PFIX="${line%%[0123456789]*}"
SFIX="${line#*[0123456789]}"
case "$SFIX" in
    [0123456789]*)
        SFIX="${SFIX#"${SFIX%%[!0123456789]*}"}"
    ;;
esac
IDLE="${line#"$PFIX"}"
IDLE="${IDLE%"$SFIX"}"
LINE="$PFIX$IDLE$SFIX"
x=0; while [ "$x" -ne 3 ]; do
    LINE="${LINE#"$PFIX$IDLE"}"
    PFIX="$PFIX$IDLE${LINE%%[0123456789]*}"
    SFIX="${LINE#*[0123456789]}"
    case "$SFIX" in
        [0123456789]*)
            SFIX="${SFIX#"${SFIX%%[!0123456789]*}"}"
        ;;
    esac
    IDLE="${LINE#"${LINE%%[0123456789]*}"}"
    IDLE="${IDLE%"$SFIX"}"
    LINE="$PFIX$IDLE$SFIX"
    x=$((x + 1))
done
PFIX="${line%%[0123456789]*}"
SFIX="${line#*[0123456789]}"
case "$SFIX" in
    [0123456789]*)
        SFIX="${SFIX#"${SFIX%%[!0123456789]*}"}"
    ;;
esac
_TOTAL="${line#"$PFIX"}"
_TOTAL="${_TOTAL%"$SFIX"}"
TOTAL="$_TOTAL"
LINE="$PFIX$_TOTAL$SFIX"
x=0; while [ "$x" -ne 6 ]; do
    LINE="${LINE#"$PFIX$_TOTAL"}"
    PFIX="$PFIX$_TOTAL${LINE%%[0123456789]*}"
    SFIX="${LINE#*[0123456789]}"
    case "$SFIX" in
        [0123456789]*)
            SFIX="${SFIX#"${SFIX%%[!0123456789]*}"}"
        ;;
    esac
    _TOTAL="${LINE#"${LINE%%[0123456789]*}"}"
    _TOTAL="${_TOTAL%"$SFIX"}"
    TOTAL=$((TOTAL + _TOTAL))
    LINE="$PFIX$_TOTAL$SFIX"
    x=$((x + 1))
done
printf "%s\n" "$IDLE" > "${TMPDIR:-/tmp}"/cpustatprevi
printf "%s\n" "$TOTAL" > "${TMPDIR:-/tmp}"/cpustatprevt
DIFF_IDLE=$((IDLE - PREV_IDLE))
DIFF_TOTAL=$((TOTAL - PREV_TOTAL))
CPU=$(((1000 * (DIFF_TOTAL - DIFF_IDLE) / DIFF_TOTAL + 5) / 10))

{ while read -r LINE; do
    case "$LINE" in
        '\''MemAvailable:'\''*)
            PFIX="${LINE%%[0123456789]*}"
            SFIX="${LINE#*[0123456789]}"
            case "$SFIX" in
                [0123456789]*)
                    SFIX="${SFIX#"${SFIX%%[!0123456789]*}"}"
                ;;
            esac

            MEMORY="${LINE#"$PFIX"}"
            MEMORY="${MEMORY%"$SFIX"}"
            MEMORY=$((MEMORY * 1024))

            MEMORY=$(awk -v '\''bytes'\''="$MEMORY" '\''
function hsize(x, base) {
	basesuf = (base == "1024") ? "iB" : "B"

	s = "BKMGTEPYZ"
	while (x >= base && length(s) > 1)
		{x /= base; s = substr(s, 2)}
	s = substr(s, 1, 1)

	xf = (s == "B") ? "%d" : "%.2f"

	if (s != "B")
		s = s basesuf

	printf((xf " %s"), x, s)
}

BEGIN {
	printf hsize(bytes, 1000)
}
            '\'' 2> /dev/null)
        ;;
    esac
done < /proc/meminfo; } 2> /dev/null

{ read -r BATTERY < /sys/class/power_supply/BAT0/capacity; } 2> /dev/null

VOLUME=$(pamixer --get-volume 2> /dev/null)

AUDIO_SINK=$(pactl list sinks 2> /dev/null)
{
_STATE=; _NAME=
while IFS= read -r LINE; do
    case "$LINE" in
        *'\''State: RUNNING'\''*) _STATE=1 ;;
    esac

    case "$LINE" in
        *'\''Name: '\''*)
            if [ "$_STATE" = 1 ]; then
                _NAME="${LINE#*Name: }"; break
            fi
        ;;
    esac
done \
<<EOF
$AUDIO_SINK
EOF

AUDIO_SINK="$_NAME"
} 2> /dev/null
case "$AUDIO_SINK" in
    '\''alsa_output'\''*) AUDIO_SINK=ALSA ;;
    '\''bluez_output'\''*) AUDIO_SINK=BLUEZ ;;
esac

KB_LAYOUT=$(
    swaymsg -t get_inputs | \
    jq '\''map(select(has("xkb_active_layout_name")))[0].xkb_active_layout_name'\''
)
case "$KB_LAYOUT" in
    *'\''English'\''*)
        KB_LAYOUT=EN
    ;;
    *'\''Bulgarian'\''*)
        KB_LAYOUT=BG
    ;;
esac

DATE=$(date "+%A%_d,%_I:%M %p" 2> /dev/null)
while :; do case "$DATE" in
    *[0123456789]'\'','\''[0123456789]*)
        DATE="${DATE%\,*}, ${DATE#*\,}"
    ;;
    *'\''day'\''[0123456789]*)
        DATE="${DATE%day*}day ${DATE#*day}"
    ;;
    *)
        break
    ;;
esac done

STATUS="$TITLE | $MEMHOG"
if [ "$NET_USAGE" ]; then
    STATUS="$STATUS | $NET_USAGE"
fi
STATUS="$STATUS | ${CPU}% | $MEMORY"
case "$BATTERY" in
    100) : ;;
    *) STATUS="$STATUS | ~${BATTERY}%" ;;
esac
STATUS="$STATUS | ${VOLUME}%"
if [ "$AUDIO_SINK" ]; then
    STATUS="$STATUS | $AUDIO_SINK"
fi
STATUS="$STATUS | $KB_LAYOUT | $DATE |"

printf "%s" "$STATUS"
'

    OBJ_PATH="$home/.config/sway/status"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group" \
        -mode 0755

    [ "$arch_linux" ] && {
        OBJ=\
'#!/bin/sh

systemctl --user import-environment \
    DISPLAY WAYLAND_DISPLAY SWAYSOCK XDG_CURRENT_DESKTOP XDG_SESSION_DESKTOP \
    DESKTOP_SESSION
dbus-update-activation-environment --systemd \
    DISPLAY WAYLAND_DISPLAY SWAYSOCK XDG_CURRENT_DESKTOP XDG_SESSION_DESKTOP \
    DESKTOP_SESSION
'

        [ ! "$portal" ] || OBJ="$OBJ"\
'
systemctl --user start \
    xdg-desktop-portal xdg-desktop-portal-gtk xdg-desktop-portal-wlr \
    xdg-document-portal xdg-permission-store
'

        OBJ="$OBJ"\
'
if [ -f /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 ]; then
    exec /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1
fi
'

        OBJ_PATH="$home/.config/sway/systemd-handler"
        __file_write_ow_soft \
            -uid "$uid" -gid "$gid" \
            -user "$user" -group "$group" \
            -mode 0755
    } || {
        OBJ_PATH="$home/.config/sway/systemd-handler"
        __action -del
    }

    OBJ=\
'#!/bin/sh

'\
"WP=$home/.config/sway/wp
"\
'WP_NEW="${TMPDIR:-/tmp}"/wp

if [ -f "$WP_NEW" ]; then
    swaymsg output '\''*'\'' bg "$WP_NEW" fill
elif [ -f "$WP" ]; then
    swaymsg output '\''*'\'' bg "$WP" fill
fi
'

    OBJ_PATH="$home/.config/sway/wp-handler"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group" \
        -mode 0755
}

_sway_conf_gaming() {
    OBJ=\
'output * adaptive_sync off
output * allow_tearing yes
output * max_render_time off

# Mod4 = Super key
set $mod Mod4
set $term kitty
set $menu exec \
    $term --class=sway-app-launcher \
    /usr/bin/sway-launcher-desktop

focus_follows_mouse always

# Prevent annoying apps from disrupting active focus by pinning them to a
# certain workplace, in our case `7`, used as a last resort workspace or "bag".
# Steam'\''s "launcher"
assign [title="Steam"] 7
# Steam
assign [class="steam"] 7

# Pin specific apps to specific workspaces.
# FeatherPad
assign [app_id="featherpad"] 2

for_window [app_id="sway-app-launcher"] \
    floating enable, sticky enable, resize set 30 ppt 60 ppt, border pixel 5
for_window [app_id="firefox"] \
    border none

input type:touchpad {
    dwt disabled
    tap enabled
}

input type:keyboard {
    xkb_layout us,bg(phonetic)
    xkb_model pc86
    xkb_options grp:alt_shift_toggle
    repeat_delay 222
    repeat_rate 50
}

# Disable mouse acceleration
input * {
    accel_profile flat
}

# Appearance {
    output * bg #241f31 solid_color
    default_border pixel
    client.focused #0A75AD #0A75AD #0A75AD #0A75AD #0A75AD
    font pango:Cantarell 12
    seat seat0 xcursor_theme Breeze
    exec_always /home/$USER/.config/sway/import-gsettings
    exec_always /home/$USER/.config/sway/wp-handler
# }

# App keybindings {
    bindsym $mod+Return exec $term
    bindsym $mod+a exec $menu
    bindsym $mod+t exec /usr/bin/Telegram
    bindsym $mod+b exec /usr/bin/blueman-manager
# }

# Control keybindings {
    bindsym $mod+1 workspace number 1
    bindsym $mod+2 workspace number 2
    bindsym $mod+3 workspace number 3
    bindsym $mod+4 workspace number 4
    bindsym $mod+5 workspace number 5
    bindsym $mod+6 workspace number 6
    bindsym $mod+7 workspace number 7

    bindsym $mod+Left focus left
    bindsym $mod+Down focus down
    bindsym $mod+Up focus up
    bindsym $mod+Right focus right
    bindsym Alt+Tab focus right
    bindsym Alt+Shift+Tab focus left

    # Basic functions
    bindsym $mod+z exec pamixer -d5
    bindsym $mod+x exec pamixer -i5
    bindsym $mod+c exec brightnessctl s 5%-
    bindsym $mod+v exec brightnessctl s 5%+
    bindsym print exec grim -l 9 $(date +'\''SS_%Y%m%d_%H%M%S.png'\'')
    bindsym $mod+p exec grim -l 9 -g "$(slurp)" \
                            $(date +'\''SS_%Y%m%d_%H%M%S.png'\'')
    bindsym $mod+Shift+p exec grim -l 9 -g "$(slurp; sleep 2.5)" \
                                  $(date +'\''SS_%Y%m%d_%H%M%S.png'\'')

    # Extended functions
    # get hex color of a pixel
    bindsym $mod+h exec grim -g "$(slurp -p)" -t ppm - | \
                        convert - -format '\''%[pixel:p{0,0}]'\'' txt:- | \
                        tail -n 1 | cut -d '\'' '\'' -f 4 | wl-copy -n
    # toggle audio playback
    bindsym $mod+Space exec /home/$USER/.config/sway/music_toggle

    # Kill window
    bindsym $mod+q kill

    # Force kill window
    bindsym $mod+Shift+q exec /home/$USER/.config/sway/fkill

    # Fullscreen window
    bindsym $mod+f fullscreen

    # Drag window by holding down $mod + LMB
    # Resize window by holding down $mod + RMB
    floating_modifier $mod normal

    # Invoke swaylock
    bindsym $mod+l exec swaylock

    # Reload the config
    bindsym $mod+Shift+c reload
# }

mode "nointercept" {
    bindsym $mod+Escape mode "default"
}
bindsym $mod+Shift+Escape mode "nointercept"

bar {
    position top
    font pango:Source Code Pro 10

    colors {
        statusline #ffffff
        background #2b2e37
        inactive_workspace #32323200 #32323200 #5c5c5c
    }
}

'

    [ ! "$arch_linux" ] || OBJ="$OBJ"\
'exec /home/$USER/.config/sway/systemd-handler
'

    OBJ="$OBJ"\
'exec_always sh -c '\''rm -f "${TMPDIR:-/tmp}"/nettotal'\''
'

    OBJ_PATH="$home/.config/sway/config"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_swaylock_conf() {
    OBJ=\
'color=2b2e37
indicator-idle-visible
inside-color=2b2e37
ring-color=0A75AD
layout-bg-color=2b2e37
layout-border-color=2b2e37
'

    OBJ_PATH="$home/.swaylock/config"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

_sysctl_conf() {
    OBJ=\
'kernel.sysrq = 1
'

    OBJ_PATH='/etc/sysctl.d/99-sysctl.conf'
    __file_write_ow_soft;
}

_tz() {
    [ "$bg" ] && {
        OBJ='/usr/share/zoneinfo/Europe/Sofia'
        OBJ_PATH='/etc/localtime'
        __obj_link_ow_soft;
    } || [ "$de" ] && {
        OBJ='/usr/share/zoneinfo/Europe/Berlin'
        OBJ_PATH='/etc/localtime'
        __obj_link_ow_soft;
    } || {
        __info -white - 'Nothing to be done.'

        return 0
    }

    __cmd -- hwclock -w
}

_xdg_conf() {
    OBJ=\
'# Programs that support:
[Added Associations]
application/json=featherpad.desktop
application/javascript=firefox.desktop

# Programs that don'\''t support:
[Removed Associations]

# Programs that will be used to open by default:
[Default Applications]
# /usr/lib/firefox/firefox: URLs / `.html` / `.pdf` / `.json`
x-scheme-handler/http=firefox.desktop
x-scheme-handler/https=firefox.desktop
text/html=firefox.desktop
application/pdf=firefox.desktop
application/json=firefox.desktop
# /usr/bin/featherpad: Text / Empty file / `.patch`/`.diff` / `.sh` / `.c` /
# JavaScript source
text/plain=featherpad.desktop
inode/x-empty=featherpad.desktop
text/x-diff=featherpad.desktop
text/x-shellscript=featherpad.desktop
text/x-c=featherpad.desktop
application/javascript=featherpad.desktop
'

    OBJ_PATH="$home/.config/mimeapps.list"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ="$home/.config/mimeapps.list"
    OBJ_PATH="$home/.local/share/applications/mimeapps.list"
    __obj_link_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"

    OBJ=\
'[icon theme]
Inherits=Breeze
'

    OBJ_PATH="$home/.icons/default/index.theme"
    __file_write_ow_soft \
        -uid "$uid" -gid "$gid" \
        -user "$user" -group "$group"
}

main() {
    # Device switches
    # ASUS VivoBook S15 X521IA-M533IA (AMD):
    m533ia=y

    # OS switches
    # Arch Linux system:
    arch_linux=y

    # Software switches
    # Configure highest audio resampling quality possible when resampling:
    audio_hq_resamp=
    # Bluetooth support (D-Bus dependent)
    bluetooth=y
    # DNS support:
    dns=y
    # Configure and prefer IPv6 over IPv4:
    ipv6=
    # XDG portals support (D-Bus dependent protocols)
    portal=y

    # Location switches
    # Bulgaria:
    bg=
    # Germany:
    de=y

    # Software
    # Audio player daemon; currently supported: moc
    audio_playerd='moc'
    # Audio server; currently supported: pipewire
    audio_server='pipewire'
    # Web browser; currently supported: firefox
    browser='firefox'
    # Display server; currently supported: wayland
    display_server='wayland'
    # Dedicated DNS (stub) resolver; currently supported: dnsmasq
    dns0='dnsmasq'
    # Init system; currently supported: systemd
    init='systemd'
    # Pipewire manager; currently supported: pipewire
    pipewire_manager='pipewire'
    # QT theme engine; currently supported: kvantum
    qt_theme='kvantum'
    # WLAN daemon; currently supported: iwd
    wland='iwd'
    # Window manager / desktop environment; currently supported: sway
    wm='sway'

    # Data
    gid='1000'
    group='mscalindt'
    hostname='m533ia'
    uid='1000'
    user='mscalindt'

    # Locations
    home='/home/mscalindt'
    efi_mnt='/efi'
    arch_mirlist='/etc/pacman.d/mirrorlist'

    opd="${1%"${1##*[!/]}"}"
    opd="${1##*/}"

    readonly m533ia arch_linux audio_hq_resamp bluetooth ipv6 portal bg de \
             audio_playerd audio_server browser display_server dns dns0 init \
             pipewire_manager qt_theme wland wm gid group hostname uid user \
             home efi_mnt arch_mirlist opd

    [ "$opd" != main ] || exit 255

    "$opd"
}

main "$@"
